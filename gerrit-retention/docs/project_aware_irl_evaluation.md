# プロジェクト別IRL評価ガイド

## 概要

このドキュメントでは、**プロジェクト単位でのIRL学習・評価**機能について説明します。以下の2つのモードを実装しています：

### モード1: クロスプロジェクト学習（Cross-Project）
- **学習**: 複数プロジェクトのデータを使用してIRLモデルを訓練
- **予測**: レビュアーが**同一プロジェクト内**でnヶ月後に活動があるかどうかを判定
- **メリット**: より多くのデータで学習できるため、汎化性能が高い
- **使用例**: 新規プロジェクトや小規模プロジェクトでの予測

### モード2: プロジェクト単位学習（Project-Specific）
- **学習**: 1つのプロジェクトのデータのみで学習
- **予測**: そのプロジェクト内での継続を判定
- **メリット**: プロジェクト固有のパターンを学習できる
- **使用例**: 大規模プロジェクトで独自の文化やプロセスがある場合

---

## 実装の詳細

### 軌跡抽出の違い

#### クロスプロジェクトモード
```python
# 全プロジェクトのデータを使用
# レビュアー×プロジェクトの組み合わせごとに軌跡を作成
for reviewer in reviewers:
    for project in reviewer_active_projects:
        # このレビュアーがこのプロジェクトで継続するか？
        continued = (予測期間中に同一プロジェクトで活動があったか)
```

**重要**: 継続ラベルは**同一プロジェクト内での活動**に基づいて判定されます。つまり、レビュアーが他のプロジェクトで活動していても、対象プロジェクトで活動がなければ「継続しない」と判定されます。

#### プロジェクト単位モード
```python
# 特定プロジェクトのデータのみを使用
df = df[df['project'] == target_project]

# そのプロジェクト内でのレビュアーの継続を予測
for reviewer in reviewers:
    continued = (予測期間中にこのプロジェクトで活動があったか)
```

---

## 使用方法

### クロスプロジェクト学習の実行

```bash
uv run python scripts/training/irl/train_temporal_irl_project_aware.py \
  --reviews data/review_requests_openstack_multi_5y_detail.csv \
  --snapshot-date 2023-01-01 \
  --history-months 6 12 \
  --target-months 6 12 \
  --mode cross-project \
  --sequence \
  --seq-len 15 \
  --epochs 30 \
  --output outputs/irl_project_cross
```

**パラメータ**:
- `--mode cross-project`: クロスプロジェクト学習モード
- `--reviews`: 複数プロジェクトのデータを含むCSVファイル（`project`カラムが必要）
- `--snapshot-date`: 学習期間と予測期間の境界日
- `--history-months`: 学習期間候補（複数指定可能）
- `--target-months`: 予測期間候補（複数指定可能）
- `--sequence`: 時系列モードを有効化（推奨）
- `--seq-len`: LSTMシーケンス長（推奨: 15）
- `--epochs`: 訓練エポック数
- `--output`: 出力ディレクトリ

### プロジェクト単位学習の実行

```bash
uv run python scripts/training/irl/train_temporal_irl_project_aware.py \
  --reviews data/review_requests_openstack_multi_5y_detail.csv \
  --snapshot-date 2023-01-01 \
  --history-months 6 12 \
  --target-months 6 12 \
  --mode project-specific \
  --projects "openstack/nova" "openstack/neutron" "openstack/cinder" \
  --sequence \
  --seq-len 15 \
  --epochs 30 \
  --output outputs/irl_project_specific
```

**追加パラメータ**:
- `--mode project-specific`: プロジェクト単位学習モード
- `--projects`: 評価対象プロジェクトリスト（複数指定可能）
  - 指定しない場合、データ量が多い上位5プロジェクトが自動選択される

---

## 評価結果の見方

### 出力ファイル

#### 1. CSV結果ファイル
- **cross-project**: `project_aware_results_cross_project_seq.csv`
- **project-specific**: `project_aware_results_project_specific_seq.csv`

**カラム**:
- `history_months`: 学習期間（ヶ月）
- `target_months`: 予測期間（ヶ月）
- `mode`: 評価モード
- `target_project`: 対象プロジェクト
- `auc_roc`, `auc_pr`, `f1`, `precision`, `recall`, `accuracy`: 評価メトリクス
- `train_samples`, `test_samples`: サンプル数
- `model_path`: 保存されたモデルのパス

#### 2. 評価レポート
- **cross-project**: `project_evaluation_report_cross_project_seq.txt`
- **project-specific**: `project_evaluation_report_project_specific_seq.txt`

レポートには以下が含まれます：
- 各メトリクスの行列表示（学習期間×予測期間）
- 最良の組み合わせ
- プロジェクト別の詳細評価（cross-projectモードのみ）
- 全体サマリー

---

## 実験結果（OpenStackデータ）

### クロスプロジェクト学習の結果

**データセット**:
- データ数: 137,632件
- プロジェクト数: 5 (nova, neutron, cinder, glance, keystone)
- 期間: 2020年〜2025年

**全体評価**:

| メトリクス | 6m学習×6m予測 | 6m学習×12m予測 | 12m学習×6m予測 | 12m学習×12m予測 |
|-----------|---------------|----------------|----------------|-----------------|
| AUC-ROC   | 0.832         | 0.796          | **0.868**      | 0.851           |
| AUC-PR    | **0.903**     | 0.894          | 0.811          | 0.851           |
| F1        | 0.773         | 0.769          | **0.830**      | 0.789           |
| Precision | **1.000**     | **1.000**      | 0.815          | 0.849           |
| Recall    | 0.630         | 0.625          | **0.846**      | 0.738           |
| Accuracy  | 0.785         | 0.772          | **0.852**      | 0.803           |

**最良の組み合わせ**: **12ヶ月学習 × 6ヶ月予測**
- AUC-ROC: 0.868
- F1: 0.830
- Accuracy: 0.852

**プロジェクト別詳細評価（12m学習×6m予測）**:

| プロジェクト          | AUC-ROC | AUC-PR | F1    |
|----------------------|---------|--------|-------|
| openstack/glance     | 0.950   | 0.944  | 0.857 |
| openstack/cinder     | 0.909   | 0.900  | 0.909 |
| openstack/nova       | 0.899   | 0.830  | 0.880 |
| openstack/neutron    | 0.804   | 0.853  | 0.750 |
| openstack/keystone   | 0.727   | 0.217  | 0.333 |

**考察**:
- クロスプロジェクト学習は全体的に高い精度を達成（AUC-ROC 0.868）
- プロジェクト別に見ると、小規模プロジェクト（glance）でも高精度
- keystoneは活動が少ないため精度が低い

---

### プロジェクト単位学習の結果

**nova プロジェクト**:

| 学習期間 | 予測期間 | AUC-ROC | AUC-PR | F1    |
|---------|---------|---------|--------|-------|
| 6m      | 6m      | 0.759   | 0.823  | 0.800 |
| 6m      | 12m     | **0.898** | **0.937** | 0.800 |
| 12m     | 6m      | 0.792   | 0.579  | 0.640 |
| 12m     | 12m     | 0.789   | 0.737  | 0.538 |

**neutron プロジェクト**:

| 学習期間 | 予測期間 | AUC-ROC | AUC-PR | F1    |
|---------|---------|---------|--------|-------|
| 6m      | 6m      | **0.831** | 0.948  | 0.556 |
| 6m      | 12m     | 0.804   | **0.952** | 0.667 |
| 12m     | 6m      | 0.707   | 0.739  | 0.545 |
| 12m     | 12m     | 0.633   | 0.693  | 0.545 |

**cinder プロジェクト**:

| 学習期間 | 予測期間 | AUC-ROC | AUC-PR | F1    |
|---------|---------|---------|--------|-------|
| 6m      | 6m      | 0.697   | 0.727  | **0.810** |
| 6m      | 12m     | 0.697   | 0.727  | **0.810** |
| 12m     | 6m      | 0.838   | 0.908  | 0.750 |
| 12m     | 12m     | **0.873** | **0.936** | 0.744 |

**全体平均**:
- AUC-ROC: 0.777 (±0.080)
- AUC-PR: 0.809 (±0.125)
- F1: 0.684 (±0.115)

**考察**:
- プロジェクト単位学習は全体的にクロスプロジェクトより低い精度
- プロジェクトによって最適な学習期間・予測期間が異なる
- novaやneutronでは短期学習（6m）が効果的
- cinderでは長期学習（12m）が効果的

---

## どちらのモードを選ぶべきか？

### クロスプロジェクト学習を選ぶべき場合

✅ **以下の条件に当てはまる場合**:
- 新規プロジェクトでデータが少ない
- 小規模プロジェクトで訓練データが不足
- 複数プロジェクトに共通する貢献者パターンを学習したい
- 汎化性能を重視したい

**メリット**:
- より多くのデータで学習できる
- 小規模プロジェクトでも高精度
- 全体的に高いAUC-ROC（0.868）

**デメリット**:
- プロジェクト固有のパターンを見逃す可能性

### プロジェクト単位学習を選ぶべき場合

✅ **以下の条件に当てはまる場合**:
- 大規模プロジェクトで十分なデータがある
- プロジェクト固有の文化やプロセスがある
- そのプロジェクトに特化した予測が必要
- プロジェクト間の違いを重視したい

**メリット**:
- プロジェクト固有のパターンを学習
- プロジェクトごとに最適化可能

**デメリット**:
- データが少ないと精度が低下
- 平均的にはクロスプロジェクトより低精度

---

## 推奨設定

### 実験結果に基づく推奨

1. **モード**: cross-project（全体的に高精度）
2. **学習期間**: 12ヶ月
3. **予測期間**: 6ヶ月
4. **シーケンス長**: 15
5. **エポック数**: 30

この組み合わせで**AUC-ROC 0.868、F1 0.830**を達成。

### プロジェクト別チューニング

プロジェクトごとに最適な設定をチューニングしたい場合：

```bash
# 複数の学習期間・予測期間を試す
uv run python scripts/training/irl/train_temporal_irl_project_aware.py \
  --reviews data/your_data.csv \
  --snapshot-date 2023-01-01 \
  --history-months 3 6 9 12 15 18 \
  --target-months 3 6 9 12 \
  --mode project-specific \
  --projects "your/project" \
  --sequence \
  --seq-len 15 \
  --epochs 30 \
  --output outputs/irl_tuning
```

レポートから最良の組み合わせを確認し、その設定を使用してください。

---

## 技術的な実装詳細

### データ構造の要件

CSVファイルには以下のカラムが必要です：

**必須カラム**:
- `project`: プロジェクト名（例: "openstack/nova"）
- `reviewer_email`: レビュアーのメールアドレス
- `request_time` または `created`: レビュー日時

**推奨カラム**:
- その他のメタデータ（オプション）

### 軌跡の構造

クロスプロジェクトモードでは、**レビュアー×プロジェクト**の組み合わせごとに軌跡を作成します：

```python
{
    'developer': {
        'developer_id': 'alice@example.com_openstack/nova',  # ユニークID
        'first_seen': datetime(2020, 1, 1),
        'changes_reviewed': 42,
        'projects': ['openstack/nova']
    },
    'activity_history': [
        {
            'type': 'review',
            'timestamp': datetime(2020, 1, 15),
            'project': 'openstack/nova',
            ...
        },
        ...
    ],
    'continued': True,  # 同一プロジェクトで継続したか
    'project': 'openstack/nova',
    'reviewer': 'alice@example.com'
}
```

### モデルの保存形式

モデルは以下の命名規則で保存されます：

**クロスプロジェクト**:
```
irl_h{学習期間}m_t{予測期間}m_cross_seq.pth
例: irl_h12m_t6m_cross_seq.pth
```

**プロジェクト単位**:
```
irl_h{学習期間}m_t{予測期間}m_{プロジェクト名}_seq.pth
例: irl_h12m_t6m_openstack_nova_seq.pth
```

---

## トラブルシューティング

### Q1: "軌跡が不足しているためスキップ" と表示される

**原因**:
- スナップショット日と学習期間の組み合わせでデータが不足
- 特定のプロジェクトのデータが少ない

**解決策**:
1. スナップショット日を調整（データが多い期間を選ぶ）
2. 学習期間を短くする
3. プロジェクト単位モードの場合、データが多いプロジェクトを選ぶ

### Q2: 特定のプロジェクトで精度が低い

**原因**:
- プロジェクトの活動が少ない
- 継続率が極端に高いまたは低い

**解決策**:
1. クロスプロジェクト学習を試す（より多くのデータで学習）
2. 学習期間・予測期間を調整
3. エポック数を増やす（過学習に注意）

### Q3: メモリ不足エラー

**原因**:
- データが大きすぎる
- シーケンス長が長すぎる

**解決策**:
1. シーケンス長を減らす（例: 15 → 10）
2. バッチサイズを減らす（コード内で調整）
3. データをサブサンプリング

---

## 次のステップ

1. **ハイパーパラメータチューニング**:
   - 学習率、隠れ層サイズ、シーケンス長などを調整
   - グリッドサーチで最適な設定を探索

2. **特徴量エンジニアリング**:
   - プロジェクトメタデータを追加（プロジェクトサイズ、活動頻度など）
   - レビュアーの属性を追加（経験年数、専門分野など）

3. **アンサンブルモデル**:
   - クロスプロジェクトモデルとプロジェクト単位モデルを組み合わせる
   - 重み付き平均で予測

4. **オンライン学習**:
   - 新しいデータが入ってきたら継続的に学習
   - モデルの再訓練を自動化

---

## 参考資料

- [README_TEMPORAL_IRL.md](../README_TEMPORAL_IRL.md): 時系列IRL学習の基本
- [seq_len_explanation.md](./seq_len_explanation.md): シーケンス長の詳細説明
- [retention_irl_system.py](../src/gerrit_retention/rl_prediction/retention_irl_system.py): IRL実装の詳細

---

## まとめ

プロジェクト別IRL評価機能により、以下が可能になりました：

✅ **クロスプロジェクト学習**: 複数プロジェクトで学習し、同一プロジェクト内の継続を予測（AUC-ROC 0.868）
✅ **プロジェクト単位学習**: プロジェクト固有のパターンを学習
✅ **柔軟な評価**: スライディングウィンドウで最適な学習期間・予測期間を探索
✅ **詳細なレポート**: プロジェクト別の精度を可視化

この機能を使って、あなたのプロジェクトに最適な貢献者継続予測モデルを構築してください！
