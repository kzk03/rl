# スライディングウィンドウIRL クロス評価 再実行記録

## 📅 実行日時
2025-10-27 05:28:49

## 🐛 修正内容

### バグ
モデルの保存/読み込みが正しく行われていなかった
- 評価時に訓練済みモデルのパラメータが読み込まれていない
- 新規作成したランダムな重みのモデルで予測していた

### 修正
1. `train_irl_sliding_window.py:464`
   ```python
   # 修正前
   irl_system = RetentionIRLSystem(config)
   irl_system.load_model(args.model)
   
   # 修正後
   irl_system = RetentionIRLSystem.load_model(args.model)
   ```

2. `train_irl_sliding_window.py:491`
   ```python
   # 修正前
   torch.save(irl_system.network.state_dict(), model_path)
   
   # 修正後
   irl_system.save_model(str(model_path))
   ```

## 🎯 実行内容

### nova単一プロジェクト
- **ディレクトリ**: `outputs/sliding_cross_eval_nova`
- **訓練期間**: 2021-01-01 ～ 2023-01-01
- **評価期間**: 2023-01-01 ～ 2024-01-01
- **訓練ラベル**: 0-3m, 3-6m, 6-9m, 9-12m (4種類)
- **評価期間**: 0-3m, 3-6m, 6-9m, 9-12m (4種類)
- **合計**: 4訓練 × 4評価 = 16実行
- **エポック数**: 20
- **最小活動数**: 1

### 実行コマンド
```bash
rm -rf outputs/sliding_cross_eval_nova
caffeinate -s -w $$ bash scripts/training/irl/run_sliding_cross_evaluation_nova.sh
```

### ログ
- メインログ: `outputs/sliding_cross_eval_nova/logs/main.log`
- 実行ログ: `/tmp/sliding_nova_rerun.log`

## 📊 期待される改善

### 修正前（バグあり）

**訓練直後の評価**:
```
train_0-3m/metrics.json:
  Precision: 0.923
  Recall: 0.522
  予測確率: 0.01-0.82 (分散あり)
```

**モデル再読み込み後の評価**:
```
train_0-3m/eval_0-3m/metrics.json:
  Precision: 0.275 (継続率と同じ)
  Recall: 1.000 (全員継続と予測)
  予測確率: 0.471-0.473 (ほぼ固定)
  → モデルが機能していない
```

### 修正後（期待）

**訓練直後の評価**:
```
train_0-3m/metrics.json:
  Precision: 0.6-0.9
  Recall: 0.5-0.7
  予測確率: 0.0-0.8 (分散あり)
```

**モデル再読み込み後の評価**:
```
train_0-3m/eval_0-3m/metrics.json:
  Precision: 0.6-0.9 (訓練時と同様)
  Recall: 0.5-0.7 (訓練時と同様)
  予測確率: 0.0-0.8 (訓練時と同様)
  → モデルが正常に機能
```

## ⏱️ 予想実行時間

- 1モデルの訓練: 約10-15分
- 1モデルの評価: 約1-2分
- 合計: 4訓練 × 15分 + 16評価 × 2分 = 約90分

## 📝 次のステップ

1. ✅ nova単一プロジェクトの再実行（実行中）
2. ⬜ 複数プロジェクト版の再実行
3. ⬜ ヒートマップ生成
4. ⬜ 結果の比較分析

## 🔍 確認コマンド

### 進捗確認
```bash
# メインログ
tail -f outputs/sliding_cross_eval_nova/logs/main.log

# 実行ログ
tail -f /tmp/sliding_nova_rerun.log

# 完了チェック
ls -la outputs/sliding_cross_eval_nova/train_*/eval_*/metrics.json
```

### 結果確認
```bash
# サマリー生成
uv run python scripts/training/irl/summarize_full_cross_evaluation.py outputs/sliding_cross_eval_nova

# ヒートマップ生成
uv run python scripts/analysis/visualize_cross_evaluation.py outputs/sliding_cross_eval_nova
```

### 修正前後の比較
```bash
# 予測確率の分布確認
uv run python3 << 'PYTHON'
import pandas as pd
import glob

for path in glob.glob('outputs/sliding_cross_eval_nova/train_*/eval_*/predictions.csv'):
    df = pd.read_csv(path)
    print(f"\n{path}:")
    print(f"  予測確率: {df['predicted_prob'].min():.4f} - {df['predicted_prob'].max():.4f}")
    print(f"  標準偏差: {df['predicted_prob'].std():.4f}")
PYTHON
```

## 📢 注意事項

- **複数プロジェクト版**（`outputs/sliding_cross_eval`）も同じバグがあるため再実行が必要
- caffeinate で実行中なので、コンピュータはスリープしない
- 実行完了まで約90分

---

実行開始: 2025-10-27 05:28:49
