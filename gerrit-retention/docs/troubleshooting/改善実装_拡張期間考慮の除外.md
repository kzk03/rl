# 改善実装: 拡張期間考慮の除外

## 📅 作成日
2025-10-30

## 🎯 変更内容

### ユーザー要求

> 訓練期間の末尾までにアサインがない人は除外して、訓練期間中に指定期間を超えて再びアサインされる可能性があるレビュアーは重み付き負例で除外しないでください。

### 実装内容

#### 1. ラベリングロジックの変更

**変更前**:
```python
if len(reviewer_label) == 0:
    # 拡張期間のレビュー依頼をチェック
    reviewer_extended_label = extended_label_df[extended_label_df[reviewer_col] == reviewer]

    # ラベル期間に依頼がない → すべて負例（依頼なし）として扱う
    future_acceptance = False
    sample_weight = 0.3  # 低い重み

    # 統計カウント
    negative_count += 1
    negative_without_requests += 1
```

**変更後**:
```python
if len(reviewer_label) == 0:
    # 拡張期間のレビュー依頼をチェック
    reviewer_extended_label = extended_label_df[extended_label_df[reviewer_col] == reviewer]

    if len(reviewer_extended_label) == 0:
        # 拡張期間にも依頼がない → 訓練期間末尾までアサインがない → 除外（実質離脱者）
        skipped_no_requests_until_end += 1
        continue  # このレビュアーをスキップ
    
    # 拡張期間に依頼がある → 訓練期間中に指定期間を超えて再びアサインされる可能性 → 重み付き負例
    future_acceptance = False
    sample_weight = 0.1  # 非常に低い重み

    # 統計カウント
    negative_count += 1
    negative_without_requests += 1
```

#### 2. 統計変数の追加

```python
skipped_no_requests_until_end = 0  # 訓練期間末尾まで依頼がない（除外）
negative_without_requests = 0  # 依頼なし（拡張期間に依頼あり）
```

#### 3. ログ出力の改善

**変更前**:
```
  スキップ（最小依頼数未満）: XX
  正例（この期間で承諾あり）: XX
  負例（この期間で承諾なし）: XX
    - 依頼あり→拒否（重み=1.0）: XX
    - 依頼なし（重み=0.3）: XX
```

**変更後**:
```
  スキップ（最小依頼数未満）: XX
  スキップ（訓練期間末尾まで依頼なし）: XX  ← NEW
  正例（この期間で承諾あり）: XX
  負例（この期間で承諾なし）: XX
    - 依頼あり→拒否（重み=1.0）: XX
    - 依頼なし（拡張期間に依頼あり、重み=0.1）: XX  ← 重み変更 + 説明追加
```

---

## 📊 期待される効果

### 1. データ品質の向上

**除外されるサンプル**:
- 訓練期間の末尾（拡張期間まで）に依頼がなかったレビュアー
- これらは実質的に離脱しており、予測可能性が低い

**重み付きで残るサンプル**:
- ラベル期間には依頼がないが、拡張期間には依頼があったレビュアー
- これらは「一時的な依頼減少」と見なせる

### 2. 正例率の改善

**前提**:
- 実質離脱者を除外することで、予測可能なサンプルのみに集中
- 正例率が上がる可能性がある

**期待値**:
- 現状: 正例率 14.9% (train_3-6m)
- 目標: 正例率 20-25%

### 3. AUC-PRの改善

**期待**:
- sample_weight=0.1 により、低重みサンプルの影響を削減
- 実質離脱者の除外により、データ品質が向上
- 平均AUC-PR 0.413 → 0.50以上を目指す

---

## 🔬 実装場所

### 修正ファイル

`scripts/training/irl/train_irl_review_acceptance.py`

#### 修正箇所

1. **`extract_training_trajectories` 関数** (line 208-222)
   - 訓練データのラベリングロジック

2. **`extract_evaluation_trajectories` 関数** (line 474-488)
   - 評価データのラベリングロジック

3. **統計変数の初期化** (line 186, 451)
   - `skipped_no_requests_until_end` の追加

4. **ログ出力** (line 346, 353, 559, 566)
   - 除外サンプル数の表示

5. **ログメッセージ** (line 138, 406)
   - ラベル定義の説明更新

---

## 📝 実験計画

### 実験設定

| 項目 | 値 |
|------|-----|
| sample_weight | 0.1（依頼なし） |
| 実質離脱者 | 除外 |
| 拡張期間に依頼あり | 重み0.1で負例 |

### 評価指標

1. **AUC-PR**: 目標 0.50以上
2. **正例率**: 現状より向上
3. **除外サンプル数**: 実質離脱者の割合
4. **Recall=1.0問題**: 発生しないこと

---

## 📊 結果（予定）

訓練完了後に以下を記録:

1. 各期間のメトリクス（AUC-PR, Precision, Recall, F1）
2. 除外されたサンプル数
3. 正例率の変化
4. ベースライン（AUC-PR 0.413）との比較

---

## 参考

- [予測性能向上案_ラベリング改善](予測性能向上案_ラベリング改善.md)
- [訓練結果_重み0.3](訓練結果_重み0.3.md)
- [負例の構成とラベリングロジック](負例の構成とラベリングロジック.md)

---

作成日: 2025-10-30

