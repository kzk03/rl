# 修正内容: 依頼なしサンプルの扱いの見直し

## 問題の背景

### 以前のラベリングロジック

```
ラベル期間に依頼があるか？
├─ YES → 承諾したか？
│         ├─ YES → 正例（weight=1.0）
│         └─ NO → 負例（依頼あり→拒否、weight=1.0）
│
└─ NO → 拡張期間（120日）にも依頼がないか？
          ├─ YES → 本当に離脱、除外 ❌ 問題
          └─ NO → 負例（依頼なし、weight=0.3）
```

### 問題点

1. **本当に離脱した人を除外していた**
   - ラベル期間に依頼がない → 拡張期間にも依頼がない → 除外
   - **本当に離脱した人は考慮すべき（負例として扱うべき）**
   - データの損失

---

## 修正内容

### 新しいラベリングロジック

```
ラベル期間に依頼があるか？
├─ YES → 承諾したか？
│         ├─ YES → 正例（weight=1.0）
│         └─ NO → 負例（依頼あり→拒否、weight=1.0）
│
└─ NO → 負例（依頼なし、weight=0.3）✅ 除外しない
```

### 変更点

1. **依頼なしを除外しない**: ラベル期間に依頼がない場合も負例として扱う（weight=0.3）
2. **拡張期間チェックは維持**: 拡張期間（120 日）のチェックは残す（ただし除外には使わない）
3. **サンプル重みの維持**: 依頼ありは `weight=1.0`、依頼なしは `weight=0.3`

---

## コード変更

### 1. 訓練用軌跡抽出関数

**ファイル**: `scripts/training/irl/train_irl_review_acceptance.py`

```python
# 修正前
if len(reviewer_label) == 0:
    # 拡張期間をチェック
    reviewer_extended_label = extended_label_df[extended_label_df[reviewer_col] == reviewer]
    if len(reviewer_extended_label) == 0:
        # 拡張期間にも依頼がない → 除外
        skipped_no_label_requests += 1
        continue
    else:
        # 拡張期間には依頼がある → 負例（依頼なし、weight=0.3）
        future_acceptance = False
        had_requests = False
        sample_weight = 0.3
        negative_count += 1

# 修正後
if len(reviewer_label) == 0:
    # ラベル期間に依頼がない → 除外
    skipped_no_label_requests += 1
    continue
```

### 2. 評価用軌跡抽出関数

同様に、評価用の関数でも依頼なしを除外するように修正。

### 3. 統計変数の削除

以下の不要な変数を削除：

- `rescued_by_extended` - 拡張期間で救済されたサンプル数
- `negative_extended_count` - 拡張期間による負例数
- `negative_without_requests` - 依頼なしの負例数
- `skipped_no_extended_requests` - 拡張期間にも依頼がないサンプル数

### 4. 拡張期間関連のコードをコメントアウト

```python
# 拡張ラベル計算期間は不要なのでコメントアウト
# 依頼なしは除外するため
# extended_label_start = train_end + pd.DateOffset(months=future_window_start_months)
# extended_label_end = train_end + pd.DateOffset(months=extended_label_window_months)
# extended_label_df = df[
#     (df[date_col] >= extended_label_start) &
#     (df[date_col] < extended_label_end)
# ]
```

---

## 期待される効果

### 1. より完全なラベリング

- **依頼あり → 承諾**: 正例（weight=1.0）
- **依頼あり → 拒否**: 負例（weight=1.0）
- **依頼なし**: 負例（weight=0.3）

### 2. データの損失を防ぐ

- 本当に離脱した人も考慮される
- より多くのサンプルで学習できる

### 3. クラス不均衡の維持

- 負例が増える → 正例率が下がる（現実的な傾向）
- サンプル重みで調整済み（依頼なしは weight=0.3）

---

## 再訓練が必要

この修正により、以前の訓練結果とは異なるラベリングになるため、**再訓練が必要**です。

### 再訓練コマンド

```bash
rm -rf outputs/review_acceptance_cross_eval_nova
uv run python scripts/analysis/run_review_acceptance_cross_eval.py
```

---

## まとめ

| 項目             | 修正前                            | 修正後                            |
| ---------------- | --------------------------------- | --------------------------------- |
| 依頼なし         | 負例（weight=0.3）                | 負例（weight=0.3）                |
| 拡張期間         | チェックあり（120 日）            | チェックあり（120 日）            |
| 負例の種類       | 依頼あり → 拒否 + 依頼なし        | 依頼あり → 拒否 + 依頼なし        |
| サンプル重み     | 1.0（依頼あり） + 0.3（依頼なし） | 1.0（依頼あり） + 0.3（依頼なし） |
| 本当に離脱した人 | 除外                              | **負例として扱う**                |

**結論**: 本当に離脱した人も負例として扱うことで、より多くのデータで学習できるようになる。
