# è©•ä¾¡ãƒ‡ãƒ¼ã‚¿å½¢å¼ä¸ä¸€è‡´ã®å•é¡Œ

## ğŸš¨ æ ¹æœ¬åŸå› 

è¨“ç·´æ™‚ã¨è©•ä¾¡æ™‚ã§ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒç•°ãªã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ãŒæ­£ã—ãäºˆæ¸¬ã§ãã¦ã„ãªã„ã€‚

### è¨“ç·´æ™‚ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼

**é–¢æ•°**: `extract_sliding_window_trajectories`
- **æœˆæ¬¡é›†ç´„**: å„æœˆã®æ´»å‹•ã‚’ã¾ã¨ã‚ã‚‹
- **ãƒ©ãƒ™ãƒ«**: å„æœˆã®æœ€çµ‚æ—¥ã‹ã‚‰å°†æ¥çª“å†…ã«æ´»å‹•ãŒã‚ã‚‹ã‹
- **ã‚·ãƒ¼ã‚±ãƒ³ã‚¹**: æœˆå˜ä½ï¼ˆä¾‹: 12ãƒ¶æœˆ = 12ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
- **activity_history**: æœˆã”ã¨ã«ã¾ã¨ã‚ã‚‰ã‚ŒãŸæ´»å‹•

```python
# è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ 
trajectory = {
    'activity_history': [
        {'timestamp': '2022-01-31', 'type': 'review', ...},  # 1æœˆã®æ´»å‹•ï¼ˆè¤‡æ•°ã‚’ã¾ã¨ã‚ã‚‹ï¼‰
        {'timestamp': '2022-02-28', 'type': 'review', ...},  # 2æœˆã®æ´»å‹•
        ...
    ],  # æœˆå˜ä½ï¼ˆ12å€‹ï¼‰
    'step_labels': [True, True, False, ...],  # å„æœˆã®ãƒ©ãƒ™ãƒ«
}
```

### è©•ä¾¡æ™‚ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼

**é–¢æ•°**: `extract_cutoff_evaluation_trajectories`
- **æœˆæ¬¡é›†ç´„ãªã—**: å…¨æ´»å‹•ã‚’å€‹åˆ¥ã«ä¿æŒ
- **ã‚·ãƒ¼ã‚±ãƒ³ã‚¹**: æ´»å‹•å˜ä½ï¼ˆä¾‹: 457ä»¶ã®æ´»å‹• = 457ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
- **activity_history**: å…¨æ´»å‹•ãŒãã®ã¾ã¾

```python
# è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ 
trajectory = {
    'activity_history': [
        {'timestamp': '2022-01-01', 'type': 'review', ...},  # å€‹åˆ¥ã®æ´»å‹•1
        {'timestamp': '2022-01-05', 'type': 'review', ...},  # å€‹åˆ¥ã®æ´»å‹•2
        {'timestamp': '2022-01-10', 'type': 'review', ...},  # å€‹åˆ¥ã®æ´»å‹•3
        ...  # 457å€‹ã®å€‹åˆ¥æ´»å‹•
    ],
    'future_contribution': True,  # ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼å…¨ä½“ã®ãƒ©ãƒ™ãƒ«
}
```

---

## ğŸ“Š ãªãœã“ã‚ŒãŒå•é¡Œãªã®ã‹

### å•é¡Œ1: ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é•·ã®ä¸ä¸€è‡´

```
è¨“ç·´æ™‚: 12ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæœˆå˜ä½ï¼‰
è©•ä¾¡æ™‚: 457ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ´»å‹•å˜ä½ï¼‰

â†’ LSTMãŒæƒ³å®šå¤–ã®é•·ã•ã‚’å—ã‘å–ã‚‹
â†’ ãƒ¢ãƒ‡ãƒ«ãŒæ··ä¹±
```

### å•é¡Œ2: ç‰¹å¾´é‡ã®æ„å‘³ãŒç•°ãªã‚‹

```python
# è¨“ç·´æ™‚ï¼ˆæœˆæ¬¡é›†ç´„ï¼‰
extract_developer_state(developer, month_activities, month_end_date)
â†’ ãã®æœˆã¾ã§ã®ç´¯ç©çµ±è¨ˆ

# è©•ä¾¡æ™‚ï¼ˆæ´»å‹•å˜ä½ï¼‰
extract_developer_state(developer, activity_history[:i+1], fixed_context_date)
â†’ iç•ªç›®ã®æ´»å‹•ã¾ã§ã®çµ±è¨ˆ
â†’ context_dateãŒå›ºå®šï¼ˆ2023-01-01ï¼‰ã§æ„å‘³ã‚’ãªã•ãªã„
```

### å•é¡Œ3: äºˆæ¸¬ç¢ºç‡ãŒ0.47ã«å›ºå®šã•ã‚Œã‚‹ç†ç”±

```python
# è©•ä¾¡æ™‚ã®äºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯
for i in range(457):  # å„æ´»å‹•ã«ã¤ã„ã¦
    step_history = activity_history[:i+1]
    step_state = extract_developer_state(developer, step_history, 2023-01-01)
    # â†’ context_dateãŒå›ºå®šã§ã€å±¥æ­´ã‚‚ç´°ã‹ã™ãã‚‹
    # â†’ ç‰¹å¾´é‡ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œãªã„
    # â†’ ãƒ¢ãƒ‡ãƒ«ãŒå…¨å“¡ã‚’ã€ŒåŒã˜ã€ã¨åˆ¤æ–­
    # â†’ äºˆæ¸¬ç¢ºç‡ãŒ0.47å‰å¾Œã«åæŸ
```

---

## âœ… è§£æ±ºç­–

### Option A: è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚‚æœˆæ¬¡é›†ç´„ã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰

```python
def extract_cutoff_evaluation_trajectories_monthly(
    df: pd.DataFrame,
    cutoff_date: pd.Timestamp,
    history_window_months: int = 12,
    future_window_start_months: int = 0,
    future_window_end_months: int = 3,
    ...
):
    """
    è¨“ç·´æ™‚ã¨åŒã˜æœˆæ¬¡é›†ç´„å½¢å¼ã§è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    """
    # å±¥æ­´æœŸé–“ã‚’æœˆå˜ä½ã«åˆ†å‰²
    history_start = cutoff_date - pd.DateOffset(months=history_window_months)
    
    for reviewer in active_reviewers:
        # æœˆã”ã¨ã®æ´»å‹•ã‚’é›†ç´„
        monthly_activities = {}
        for _, row in reviewer_history.iterrows():
            month_key = (row[date_col].year, row[date_col].month)
            if month_key not in monthly_activities:
                monthly_activities[month_key] = []
            monthly_activities[month_key].append(row)
        
        # æœˆæ¬¡ã® activity_history ã‚’æ§‹ç¯‰
        activity_history = []
        for month_key in sorted(monthly_activities.keys()):
            month_activities = monthly_activities[month_key]
            # æœˆã®æœ€çµ‚æ´»å‹•ã‚’ä»£è¡¨ã¨ã—ã¦ä½¿ç”¨
            last_activity = month_activities[-1]
            activity_history.append({
                'timestamp': last_activity[date_col],
                'action_type': 'review',
                'project': last_activity['project'],
                'monthly_count': len(month_activities),  # ã“ã®æœˆã®æ´»å‹•æ•°
            })
        
        # ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼å…¨ä½“ã®ãƒ©ãƒ™ãƒ«
        future_contribution = len(reviewer_future) > 0
        
        trajectory = {
            'developer': developer_info,
            'activity_history': activity_history,  # æœˆæ¬¡é›†ç´„
            'context_date': cutoff_date,
            'future_contribution': future_contribution,
        }
        trajectories.append(trajectory)
```

### Option B: äºˆæ¸¬æ™‚ã«æœˆæ¬¡é›†ç´„ã‚’è¡Œã†ï¼ˆè¤‡é›‘ï¼‰

```python
def predict_continuation_probability(...):
    # activity_historyã‚’æœˆæ¬¡ã«é›†ç´„
    monthly_activities = aggregate_by_month(activity_history)
    
    # æœˆæ¬¡é›†ç´„ã•ã‚ŒãŸå±¥æ­´ã§äºˆæ¸¬
    ...
```

### Option C: è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‚’æ´»å‹•å˜ä½ã«ã™ã‚‹ï¼ˆéæ¨å¥¨ï¼‰

```
å•é¡Œ:
- ãƒ©ãƒ™ãƒ«ä»˜ã‘ãŒè¤‡é›‘ã«ãªã‚‹
- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒé•·ã™ãã‚‹
- è¨ˆç®—ã‚³ã‚¹ãƒˆãŒå¢—åŠ 
```

---

## ğŸ¯ æ¨å¥¨å®Ÿè£…: Option A

### å®Ÿè£…æ‰‹é †

1. **æ–°ã—ã„é–¢æ•°ã‚’ä½œæˆ**:
   ```python
   scripts/training/irl/train_irl_within_training_period.py
   ã« extract_cutoff_evaluation_trajectories_monthly ã‚’è¿½åŠ 
   ```

2. **ã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç‰ˆã§ä½¿ç”¨**:
   ```python
   scripts/training/irl/train_irl_sliding_window.py
   ã§ extract_cutoff_evaluation_trajectories_monthly ã‚’ä½¿ç”¨
   ```

3. **å†å®Ÿè¡Œ**:
   ```bash
   bash scripts/training/irl/run_sliding_cross_evaluation_nova.sh
   ```

---

## æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„

### ä¿®æ­£å‰ï¼ˆç¾çŠ¶ï¼‰

```
è©•ä¾¡æ™‚:
  äºˆæ¸¬ç¢ºç‡: å…¨å“¡0.47ï¼ˆå›ºå®šï¼‰
  Precision: 0.27 (ç¶™ç¶šç‡ã¨åŒã˜)
  Recall: 1.00 (å…¨å“¡ç¶™ç¶šã¨äºˆæ¸¬)
```

### ä¿®æ­£å¾Œï¼ˆæœŸå¾…ï¼‰

```
è©•ä¾¡æ™‚:
  äºˆæ¸¬ç¢ºç‡: 0.0-1.0ï¼ˆåºƒã„åˆ†å¸ƒï¼‰
  Precision: 0.6-0.8
  Recall: 0.6-0.8
  â†’ è¨“ç·´æ™‚ã¨åŒæ§˜ã®ãƒãƒ©ãƒ³ã‚¹
```

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… **extract_cutoff_evaluation_trajectories_monthly ã‚’å®Ÿè£…**
2. âœ… **train_irl_sliding_window.py ã§ä½¿ç”¨**
3. âš ï¸ **1ã¤ã®ãƒ¢ãƒ‡ãƒ«ã§ãƒ†ã‚¹ãƒˆ**
4. â¬œ **å…¨ãƒ¢ãƒ‡ãƒ«ã§å†å®Ÿè¡Œ**

å®Ÿè£…ã—ã¾ã™ã‹ï¼Ÿ
