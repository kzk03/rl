# 負例割合調査とパラメータ調整

## 調査結果

### 負例が増加

依頼なしも含めてすべての負例を扱うようにした結果、**負例が大幅に増加**しました。

#### 比較

| 項目       | 以前（重量 0.3 版） | 現在      | 変化    |
| ---------- | ------------------- | --------- | ------- |
| 平均正例率 | 34.7%               | **14.0%** | -20.7pt |
| 最小正例率 | 31.0%               | **10.7%** | -20.3pt |
| 最大正例率 | 41.0%               | **17.4%** | -23.6pt |

### 詳細な正例率

| 期間        | 正例 | 負例 | 合計 | 正例率    |
| ----------- | ---- | ---- | ---- | --------- |
| train_0-3m  | 21   | 100  | 121  | **17.4%** |
| train_3-6m  | 18   | 103  | 121  | **14.9%** |
| train_6-9m  | 13   | 108  | 121  | **10.7%** |
| train_9-12m | 16   | 105  | 121  | **13.2%** |

### 問題点

1. **極端なクラス不均衡**: 正例率が 10.7%~17.4%と低い
2. **サンプル数の増加**: 39~60 サンプル → 121 サンプル（各期間）
3. **精度低下**: AUC-PR が 0.3 台に低下

---

## パラメータ調整

### sample_weight の調整

正例率が大幅に低下したため、依頼なしのサンプル重みを**さらに下げる**必要があります。

#### 調整内容

- **変更前**: `sample_weight = 0.3`（依頼なし）
- **変更後**: `sample_weight = 0.1`（依頼なし）
- **依頼あり**: `sample_weight = 1.0`（変更なし）

#### 効果の期待

1. **依頼なしの影響をさらに軽減**: より小さな重みで学習
2. **正例の重要度を相対的に上げる**: 1.0 vs 0.1 = 10 倍の差
3. **精度の改善**: よりバランスの取れた学習

---

## 再訓練

### 実行設定

- **サンプル重み**: 0.1（依頼なし）、1.0（依頼あり）
- **Random Seed**: 777
- **Learning Rate**: 0.00005
- **Epochs**: 20
- **Dropout**: 0.3

### 期待される結果

1. **精度の向上**: AUC-PR が改善
2. **バランスの改善**: 正例と負例のバランスが改善
3. **Recall=1.0 問題**: 解決維持

---

## 今後の対応

### さらなる調整が必要な場合

1. **sample_weight をさらに下げる**: 0.1 → 0.05
2. **学習率の調整**: より小さく、より大きく
3. **エポック数の調整**: 20 → 30, 50
4. **ドロップアウトの調整**: 0.3 → 0.4, 0.5

### データの拡充

1. **他のプロジェクトからデータ追加**: neutron, cinder
2. **より長期間のデータ収集**
3. **サンプル数の増加**

---

## まとめ

- **負例が大幅に増加**: 平均正例率 34.7% → 14.0%
- **sample_weight を 0.3 → 0.1 に調整**
- **再訓練実施中**: 結果を待つ
