# 負例の構成とラベリングロジック

## 負例の 2 つの種類

### 1. 依頼あり → 拒否（weight=1.0）

- **定義**: レビュー依頼を受けたが、すべて拒否した
- **重み**: 1.0（高重要度）
- **理由**: 明確な拒否シグナルとしてモデルに学習させる
- **意味**: 実際に依頼を受けても拒否する = 離脱の兆候

### 2. 依頼なし（weight=0.3）

- **定義**: レビュー依頼そのものが来なかった
- **重み**: 0.3（低重要度）
- **理由**: 本当に離脱したのか、単にアサインされなかったのか不明
- **意味**: 依頼が来ない = 離脱の可能性があるが確実ではない

---

## 負例が多い理由

### 1. 正例が少ない（現実的な傾向）

| 期間        | 正例 | 負例 | 正例率 |
| ----------- | ---- | ---- | ------ |
| train_0-3m  | 21   | 39   | 35.0%  |
| train_3-6m  | 18   | 37   | 32.7%  |
| train_6-9m  | 13   | 29   | 31.0%  |
| train_9-12m | 16   | 23   | 41.0%  |

- **平均正例率**: 34.7%
- **負例が約 2 倍**: 正例の約 2 倍存在する
- **これは現実的な傾向**: レビュー依頼を受けて実際に承諾する人は限られている

### 2. 依頼なしが多数含まれる

- **拡張期間チェック**: 120 日間にも依頼がない場合は除外
- **しかし**: 多くがまだ負例として含まれている
- **理由**: 依頼が来ないことも離脱の兆候と判断

### 3. 拒否が多数含まれる

- **依頼を受けたが拒否**: これも離脱の兆候
- **モデルにとって重要**: 明確な拒否シグナルとして学習

---

## ラベリングロジック

### 現在の実装

```python
# scripts/training/irl/train_irl_review_acceptance.py

# 1. 通常のラベル期間に依頼がある場合
if len(reviewer_label) > 0:
    accepted_requests = reviewer_label[reviewer_label[label_col] == 1]
    rejected_requests = reviewer_label[reviewer_label[label_col] == 0]
    future_acceptance = len(accepted_requests) > 0  # 承諾があるか
    had_requests = True
    sample_weight = 1.0

    if future_acceptance:
        positive_count += 1  # 承諾あり → 正例
    else:
        negative_count += 1  # 全て拒否 → 負例（依頼あり→拒否）
        negative_with_requests += 1

# 2. 通常のラベル期間に依頼がない場合
else:
    # 拡張期間（120日）をチェック
    reviewer_extended_label = extended_label_df[reviewer_extended_label[reviewer_col] == reviewer]

    if len(reviewer_extended_label) == 0:
        # 拡張期間にも依頼がない → 本当に離脱、除外
        skipped_no_label_requests += 1
        continue
    else:
        # 拡張期間には依頼がある → この期間では活動しなかったので負例
        future_acceptance = False  # この期間では活動なし
        had_requests = False  # この期間に依頼がなかった
        sample_weight = 0.3  # 低い重み（依頼なし）
        negative_count += 1  # 依頼なし → 負例
        negative_without_requests += 1
```

### 判定フロー

```
レビュー依頼データ
    ↓
通常のラベル期間に依頼があるか？
    ├─ YES → 承諾したか？
    │         ├─ YES → 正例（weight=1.0）
    │         └─ NO → 負例（依頼あり→拒否、weight=1.0）
    │
    └─ NO → 拡張期間（120日）にも依頼がないか？
              ├─ YES → 本当に離脱、除外
              └─ NO → 負例（依頼なし、weight=0.3）
```

---

## 負例の内訳（推定）

### train_0-3m（負例 39）

- **依頼あり → 拒否**: 約 20-30 サンプル（推定）
- **依頼なし**: 約 10-20 サンプル（推定）

### train_9-12m（負例 23）

- **依頼あり → 拒否**: 約 10-15 サンプル（推定）
- **依頼なし**: 約 8-13 サンプル（推定）

### 傾向

- **期間が長くなるほど負例が少なくなる**
- **これは**: 長期間活動していた人は継続しやすい（survivor bias）
- **短い期間**: 多くの人が離脱している

---

## 改善案

### 1. 依頼なしの除外条件を厳しく

- **現状**: 拡張期間（120 日）にも依頼がない場合のみ除外
- **問題**: まだ多くの「依頼なし」が負例として含まれている
- **改善**: 拡張期間をさらに延長（180 日、240 日など）

### 2. 正例の増加

- **他のプロジェクトからデータ追加**: neutron, cinder など
- **より多くの正例サンプルを取得**
- **クラス不均衡の改善**

### 3. サンプル重みの調整（すでに実施済み）

- **依頼なし**: weight=0.3（低重要度）
- **依頼あり → 拒否**: weight=1.0（高重要度）
- **効果**: 依頼なしの影響を抑制

### 4. 検索条件の見直し

- **現在**: プロジェクトでフィルタしているが、まだ「依頼なし」が多い
- **改善**: より積極的なレビュアーのみを対象にする

---

## まとめ

**負例が多い理由**:

1. **正例が少ない（現実的な傾向）**: レビュー依頼を受けて実際に承諾する人は限られている
2. **依頼なしが多数含まれる**: レビュー依頼が来ないことも離脱の兆候と判断
3. **拒否が多数含まれる**: 依頼を受けても拒否するケースが多い

**現在の対策**:

- **サンプル重みの調整**: 依頼なしを weight=0.3 に設定
- **拡張期間チェック**: 120 日間にも依頼がない場合は除外

**今後の改善方向**:

1. **依頼なしの除外条件を厳しく**（拡張期間を延長）
2. **正例の増加**（他のプロジェクトからデータ追加）
3. **より積極的なレビュアーのみを対象**
