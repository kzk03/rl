# 精度低下の原因分析

## 問題

重み付きラベル IRL 実装後のモデル精度が大幅に低下しました。

**最良設定**: 平均 AUC-PR **0.664**  
**現在**: 平均 AUC-PR **0.506** （**-23.8%**）

---

## 実装状況の確認

### ✅ 実装済み

1. **軌跡データに`sample_weight`を追加**: `train_irl_review_acceptance.py` 行 566
2. **損失計算で重みを適用**: `retention_irl_system.py` 行 1323-1329
3. **拡張期間チェックを実装**: `train_irl_review_acceptance.py` 行 482-504

### 重みの設定

- `had_requests=False` (依頼なし): `sample_weight = 0.7`
- `had_requests=True` (依頼あり): `sample_weight = 1.0`

---

## 精度低下の仮説

### 仮説 1: 訓練サンプル数の増加と正例率の低下 ⭐ 最有力

**背景**:

- 拡張期間（0-12m）チェックで、ラベル期間に依頼がないサンプルも負例として追加
- 増加したサンプルは**全て負例（ラベル=0）**
- 正例率が下がる → モデルが負例に偏る → Recall=1.0 問題の悪化

**確認すべきデータ**:

- 訓練サンプル数（実装前 vs 実装後）
- 正例数（実装前 vs 実装後）
- 拡張期間で「救済」されたサンプル数（`rescued_by_extended`）

### 仮説 2: 重みの効果が不十分

**背景**:

- `weight=0.7` と `weight=1.0` の差が小さい
- 「依頼なし」と「依頼あり → 拒否」を明確に区別できない
- 重みが機能していない可能性

**確認すべきデータ**:

- `weight=0.7`のサンプル数
- `weight=1.0`のサンプル数
- 損失への重みの影響

### 仮説 3: Focal Loss と重みの相互作用

**背景**:

- Focal Loss は `alpha` と `gamma` で動的に調整
- サンプル重み（0.7 vs 1.0）との相互作用が不明
- 重みが効いているかどうか不明確

**確認方法**:

- Focal Loss 計算時に重みが正しく適用されているか
- 重みの効果を可視化

---

## 調査すべきデータ

### 1. 訓練データの統計

```python
# 各訓練期間で
- 総サンプル数
- 正例数（future_acceptance=True）
- 負例数（future_acceptance=False）
- 正例率
- rescued_by_extended 数
- negative_with_requests 数
- negative_without_requests 数
```

### 2. 重みの分布

```python
# 各訓練期間で
- weight=0.7 のサンプル数
- weight=1.0 のサンプル数
- 重み別の正例率
```

### 3. 性能比較

```python
# 実装前（最良設定） vs 実装後
- サンプル数
- 正例率
- AUC-PR
- Recall
```

---

## 推奨される対策

### 対策 1: 重み付きラベル IRL を無効化 ⭐ 推奨

**理由**:

- 実装前の精度（0.664）が優秀
- 拡張期間チェックが逆効果だった可能性
- train_6-9m のみ Recall=1.0 問題があるが、許容範囲内

**手順**:

1. 拡張期間チェックをコメントアウト
2. `sample_weight` を常に 1.0 に設定
3. 最良設定（Seed 777, LR 0.00005, Epoch 20, Dropout 0.3）で再訓練

### 対策 2: 重みを調整して再試行

**内容**:

- `weight=0.7` → `weight=0.3` or `weight=0.5`
- より明確に「依頼なし」と「依頼あり → 拒否」を区別

**リスク**:

- 精度がさらに低下する可能性

### 対策 3: 拡張期間の見直し

**内容**:

- 拡張期間を短縮（12m → 6m）
- または拡張期間チェックを削除

---

## 結論

**最良設定が既にある**ため、重み付きラベル IRL の実装は逆効果だった可能性が高い。

**推奨**: 実装前（最良設定）に戻す

- Seed 777
- LR 0.00005
- Epoch 20
- Dropout 0.3
- 拡張期間チェック無効

---

## 関連ドキュメント

- `docs/ラベル付けロジック_詳細解説.md`: ラベル付けロジックの詳細
- `docs/重み付きラベルIRL_実装確認と精度調査.md`: 実装状況の確認
