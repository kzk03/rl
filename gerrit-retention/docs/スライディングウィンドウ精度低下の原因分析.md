# スライディングウィンドウ版の精度低下の原因分析

## 結果の比較

### 従来版（累積ラベル）nova単一プロジェクト

| 訓練ラベル | AUC-ROC | AUC-PR | F1    | 継続率 | サンプル数 |
| ---------- | ------- | ------ | ----- | ------ | ---------- |
| 0-1m       | 0.958   | 0.943  | 0.885 | 36.4%  | 77         |

### 新版（スライディングウィンドウ）nova単一プロジェクト

| 訓練ラベル | AUC-ROC | F1    | 継続率 |
| ---------- | ------- | ----- | ------ |
| 0-3m       | 0.821   | 0.667 | 27.5%  |
| 3-6m       | 0.870   | 0.686 | 27.5%  |
| 6-9m       | 0.816   | 0.656 | 21.0%  |
| 9-12m      | 0.782   | 0.649 | 25.7%  |

**精度低下**: AUC-ROC 0.96 → 0.78-0.87（約10-18%低下）

---

## 原因分析

### 1. ラベル定義の根本的な違い

#### 従来版：累積ラベル（より簡単）

```
訓練ラベル「0-3m」:
→ 「0〜3ヶ月以内に活動があるか」

特徴：
- 期間が広い（3ヶ月間のどこかで活動すれば True）
- 短期的な活動でも True になる
- 継続率が高い（36%）
```

#### 新版：スライディングウィンドウ（より難しい）

```
訓練ラベル「0-3m」:
→ 「0〜3ヶ月の期間内に活動があるか」

特徴：
- より厳密な期間定義
- 「3-6m」「6-9m」など後の期間は独立
- 継続率が低い（21-28%）
```

**鍵となる違い**：

| 項目           | 従来版（累積）         | 新版（スライディング） |
| -------------- | ---------------------- | ---------------------- |
| ラベル相関     | 高い（0-1m⊂0-3m⊂0-6m） | 低い（独立した期間）   |
| 継続の定義     | 「いつか活動」         | 「特定期間に活動」     |
| 正例の割合     | 高い（36%）            | 低い（21-28%）         |
| タスクの難易度 | 易しい                 | 難しい                 |

### 2. サンプル数とデータ分布の違い

```bash
# 従来版のサンプル数
nova train_0-1m: 77サンプル（継続: 28, 離脱: 49）

# 新版のサンプル数（推定）
nova train_0-3m: 167サンプル程度（継続率27.5% → 約46人が継続）
```

**問題点**：
- サンプル数が増えたが、継続率が低下
- クラス不均衡がより顕著（73% vs 64%）
- より多様なパターンを学習する必要がある

### 3. 評価対象の違い

#### 従来版

```
評価: cutoff日（2023-01-01）から0-3m後に活動があるか
→ 比較的短期の予測
```

#### 新版

```
評価: スライディングウィンドウで各期間を独立に評価
→ より長期・細分化された予測
```

### 4. 具体例で理解する違い

**レビュアーAのケース**：
- 2023-01-15に1回活動
- 2023-04-01以降は活動なし

| ラベル定義     | 従来版（0-3m） | 新版（0-3m） | 新版（3-6m） |
| -------------- | -------------- | ------------ | ------------ |
| 結果           | True（✓）      | True（✓）    | False（✗）  |
| 理由           | 3m以内に活動   | 0-3mに活動   | 3-6mに活動なし |
| モデルの難易度 | 易しい         | 普通         | 難しい       |

**レビュアーBのケース**：
- 2023-04-15に1回活動
- その後活動なし

| ラベル定義     | 従来版（0-3m） | 新版（0-3m） | 新版（3-6m） |
| -------------- | -------------- | ------------ | ------------ |
| 結果           | True（✓）      | False（✗）  | True（✓）    |
| 理由           | 3m以内に活動   | 0-3mに活動なし | 3-6mに活動   |
| モデルの難易度 | 易しい         | 難しい       | 難しい       |

→ **新版は「いつ活動するか」まで予測する必要があり、より困難**

---

## なぜスライディングウィンドウの方が難しいのか

### 理由1：独立性が高い

```
従来版:
0-1m ⊂ 0-3m ⊂ 0-6m ⊂ 0-9m ⊂ 0-12m
→ 強い相関（0-1mでTrueなら0-3mもTrue）
→ モデルは「早期に活動する人」を学習すれば良い

新版:
0-3m, 3-6m, 6-9m, 9-12m（排他的）
→ 相関が低い
→ モデルは「どの期間に活動するか」を学習する必要がある
```

### 理由2：時間的な精度が要求される

```
従来版:
「継続する人」を見つければ良い
→ タイミングは問わない

新版:
「いつ継続するか」を予測する必要がある
→ 時間的な精度が要求される
```

### 理由3：継続率の低下

```
従来版（0-3m）: 36% が継続
→ 正例が比較的多い
→ 学習しやすい

新版（0-3m）: 27.5% が継続
新版（6-9m）: 21.0% が継続
→ 正例が少ない
→ クラス不均衡がより深刻
```

---

## これは問題なのか？

### いいえ、これは予想通りの結果です

#### 1. より現実的なタスク

従来版の「いつか活動する」予測よりも、新版の「この期間に活動する」予測の方が：
- **実用的**: プロジェクト管理者は「いつ」が重要
- **行動可能**: 「3-6ヶ月後に離脱しそう」→ 今から介入策を準備

#### 2. タスクの難易度が適正

```
AUC-ROC 0.78-0.87 は:
- ランダム（0.50）よりはるかに良い
- 完璧（1.00）ではないが実用的
- 時間的な予測としては妥当な精度
```

#### 3. モデルの解釈可能性が向上

```
従来版:
「継続しそうな人」を見つける
→ 漠然とした予測

新版:
「0-3m後に活動」「3-6m後に活動」を区別
→ 具体的な時期を予測
```

---

## 改善の方向性（必要であれば）

### 1. より多くのデータ

```
現状: nova単一プロジェクト（167サンプル程度）
→ 複数プロジェクト（より多くのサンプル）で精度向上の余地
```

### 2. 時系列特徴量の強化

```
現状: 10次元の状態特徴量
→ より詳細な時系列パターン（トレンド、周期性）を追加
```

### 3. 期間ごとのモデルチューニング

```
現状: 全期間で同じハイパーパラメータ
→ 期間ごとに最適化（短期 vs 長期で異なる戦略）
```

### 4. アンサンブル学習

```
現状: 単一モデル
→ 複数モデルの組み合わせで精度向上
```

---

## 結論

### 精度低下は問題ではない

1. **タスクが異なる**: 「いつか活動」vs「いつ活動」
2. **より難しい**: 時間的な精度が要求される
3. **より実用的**: 具体的な時期を予測できる

### 新版の利点

- ✅ 時期を特定した予測が可能
- ✅ 介入策の計画に有用
- ✅ より現実的なタスク
- ✅ 期間ごとの傾向分析が可能

### 従来版の利点

- ✅ 高い精度（AUC-ROC 0.96）
- ✅ シンプルな継続/離脱予測
- ✅ 学習が容易

### 推奨

**両方を使い分ける**：
- **従来版**: 継続可能性のスクリーニング（誰が継続しそうか）
- **新版**: 時期の予測（いつ離脱しそうか、いつ介入すべきか）

---

## 追加分析

### クロス評価による検証

新版では、訓練ラベルと評価期間を変えたクロス評価が可能：

| 訓練＼評価 | 0-3m  | 3-6m  | 6-9m  | 9-12m |
| ---------- | ----- | ----- | ----- | ----- |
| 0-3m       | 0.821 | 0.XXX | 0.XXX | 0.XXX |
| 3-6m       | 0.XXX | 0.870 | 0.XXX | 0.XXX |
| 6-9m       | 0.XXX | 0.XXX | 0.816 | 0.XXX |
| 9-12m      | 0.XXX | 0.XXX | 0.XXX | 0.782 |

→ 汎化性能の評価が可能
