# IRL 実験ロードマップ

## 🎯 将来的にできる比較実験

学習期間内完結型 IRL で可能な比較実験と、その実装状況をまとめています。

---

## 📊 実験の全体像

```
Phase 1: スライディングウィンドウ評価 ✅ 実装済み
├─ 履歴窓 × 将来窓の全組み合わせ（16実験）
├─ AUC-ROC/AUC-PR/F1の行列比較
└─ ヒートマップ可視化

Phase 2: 時間的汎化性能評価 ✅ 実装済み
├─ 複数の評価期間でテスト
├─ 性能劣化の分析
└─ 再訓練タイミングの推奨

Phase 3: ローリングウィンドウ評価 🔜 今後実装
├─ 訓練期間を3ヶ月ずつスライド
├─ 季節性の影響を分析
└─ 性能の安定性を評価

Phase 4: 層別分析 🔜 今後実装
├─ プロジェクト別の性能
├─ 経験レベル別の性能
└─ 活動レベル別の性能
```

---

## ✅ Phase 1: スライディングウィンドウ評価（実装済み）

### 目的

**RQ1: 最適な履歴窓と将来窓の組み合わせは？**

### 実験内容

```python
履歴窓: [3, 6, 9, 12] ヶ月
将来窓: [(0,1), (1,3), (3,6), (6,12)] ヶ月

総実験数: 4 × 4 = 16
```

### 実行方法

```bash
# デフォルト設定で実行
./scripts/training/irl/run_sliding_window_evaluation.sh

# カスタム設定
uv run python scripts/training/irl/train_irl_sliding_window_evaluation.py \
  --reviews data/review_requests_openstack_multi_5y_detail.csv \
  --train-start 2019-01-01 \
  --train-end 2020-01-01 \
  --history-windows 3 6 9 12 \
  --future-windows 0-1 1-3 3-6 6-12 \
  --epochs 30 \
  --sequence \
  --output outputs/sliding_window_evaluation
```

### 出力

- `auc_roc_matrix.csv` - AUC-ROC 行列
- `sliding_window_heatmaps.png` - ヒートマップ可視化
- `all_results.json` - 全結果

### 期待される発見

- 最適な組み合わせ（例: 12m 履歴 × 1-3m 将来窓）
- 短い履歴では長期予測が困難
- 長い履歴では短期予測が過剰適合

### 論文での活用

**Table 1: 履歴窓 × 将来窓の組み合わせ評価（AUC-ROC）**

|     | 0-1m  | 1-3m      | 3-6m  | 6-12m |
| --- | ----- | --------- | ----- | ----- |
| 3m  | 0.731 | 0.682     | 0.654 | 0.612 |
| 6m  | 0.842 | 0.802     | 0.757 | 0.718 |
| 9m  | 0.853 | 0.750     | 0.727 | 0.762 |
| 12m | 0.777 | **0.855** | 0.799 | 0.791 |

**Figure 1: スライディングウィンドウ評価のヒートマップ**

---

## ✅ Phase 2: 時間的汎化性能評価（実装済み）

### 目的

**RQ3: モデルの時間的汎化性能は？再訓練はいつ必要か？**

### 実験内容

```python
# 固定された訓練期間
train_period = ('2019-01-01', '2020-01-01')

# 複数の評価期間
eval_periods = [
    ('2020-01-01', '2020-07-01'),  # +0-6ヶ月
    ('2020-07-01', '2021-01-01'),  # +6-12ヶ月
    ('2021-01-01', '2021-07-01'),  # +12-18ヶ月
    ('2021-07-01', '2022-01-01'),  # +18-24ヶ月
]
```

### 実行方法

```bash
# デフォルト設定で実行
./scripts/training/irl/run_temporal_generalization.sh

# カスタム設定
uv run python scripts/training/irl/evaluate_temporal_generalization.py \
  --reviews data/review_requests_openstack_multi_5y_detail.csv \
  --train-start 2019-01-01 \
  --train-end 2020-01-01 \
  --eval-interval-months 6 \
  --num-eval-periods 4 \
  --output outputs/temporal_generalization
```

### 期待される発見

- 時間経過による性能劣化
- 6 ヶ月後から顕著な性能低下
- 3-6 ヶ月ごとの再訓練を推奨

### 論文での活用

**Figure 2: 時間経過による性能の推移**

```
AUC-ROC
 0.85 |●
      |  ●
 0.80 |    ●
      |      ●
 0.75 |________●_______
      0  6  12  18  24 (months after training)
```

---

## 🔜 Phase 3: ローリングウィンドウ評価（今後実装）

### 目的

**季節性や時期による影響を分析、性能の安定性を評価**

### 実験内容

```python
# 訓練期間を3ヶ月ずつスライド
window_size = 12  # 12ヶ月
slide_months = 3   # 3ヶ月ごと

rolling_periods = [
    (train: '2019-01-01~2020-01-01', eval: '2020-01-01~2020-07-01'),
    (train: '2019-04-01~2020-04-01', eval: '2020-04-01~2020-10-01'),
    (train: '2019-07-01~2020-07-01', eval: '2020-07-01~2021-01-01'),
    (train: '2019-10-01~2020-10-01', eval: '2020-10-01~2021-04-01'),
]
```

### 実装予定スクリプト

```bash
# scripts/training/irl/evaluate_rolling_window.py

uv run python scripts/training/irl/evaluate_rolling_window.py \
  --window-size 12 \
  --slide-months 3 \
  --start-date 2019-01-01 \
  --end-date 2021-01-01 \
  --output outputs/rolling_window
```

### 期待される発見

- 季節性の影響（夏 vs 冬）
- 性能の安定性（標準偏差）
- プロジェクトの変化の影響

### 論文での活用

**Figure 3: ローリングウィンドウによる性能の時系列推移**

```
AUC-ROC
 0.90 |  ●   ●     ●
 0.85 | ● ● ● ● ● ● ●
 0.80 |_______________
      2019  2019  2020  2020
       Q1    Q3    Q1    Q3
```

---

## 🔜 Phase 4: 層別分析（今後実装）

### 目的

**サブグループごとの予測精度の違いを分析**

### 実験内容

#### 4.1 プロジェクト別

```python
projects = ['nova', 'neutron', 'cinder', 'glance']

for project in projects:
    metrics = evaluate_by_project(model, project)
```

#### 4.2 経験レベル別

```python
experience_levels = [
    {'name': '新人', 'tenure_days': '<90'},
    {'name': '中堅', 'tenure_days': '90-365'},
    {'name': 'ベテラン', 'tenure_days': '>365'},
]

for level in experience_levels:
    metrics = evaluate_by_experience(model, level)
```

#### 4.3 活動レベル別

```python
activity_levels = [
    {'name': '高活動', 'reviews_30d': '>=10'},
    {'name': '中活動', 'reviews_30d': '3-9'},
    {'name': '低活動', 'reviews_30d': '<3'},
]
```

### 実装予定スクリプト

```bash
# scripts/training/irl/evaluate_stratified_analysis.py

uv run python scripts/training/irl/evaluate_stratified_analysis.py \
  --model outputs/irl_best/irl_model.pth \
  --stratify project experience activity \
  --output outputs/stratified_analysis
```

### 期待される発見

- 大規模プロジェクト（nova）は予測しやすい
- 新人の離脱予測は困難
- 低活動者は予測精度が低い

### 論文での活用

**Table 2: サブグループごとの予測精度（AUC-ROC）**

| カテゴリ     | グループ          | AUC-ROC | サンプル数 |
| ------------ | ----------------- | ------- | ---------- |
| プロジェクト | nova              | 0.872   | 5432       |
|              | neutron           | 0.843   | 3241       |
| 経験レベル   | 新人（<90d）      | 0.712   | 1234       |
|              | 中堅（90-365d）   | 0.851   | 2345       |
|              | ベテラン（>365d） | 0.889   | 3456       |

---

## 🎓 研究課題（RQ）と実験の対応

| RQ  | 研究課題                         | 実験               | 実装状況 |
| --- | -------------------------------- | ------------------ | -------- |
| RQ1 | 最適な履歴窓と将来窓の組み合わせ | スライディング評価 | ✅ 完了  |
| RQ2 | LSTM の効果                      | LSTM 有無比較      | ✅ 可能  |
| RQ3 | 時間的汎化性能                   | 時間的汎化評価     | ✅ 完了  |
| RQ4 | サブグループごとの違い           | 層別分析           | 🔜 予定  |

---

## 📅 実装スケジュール（参考）

### Week 1（完了）

✅ 学習期間内完結型 IRL の設計  
✅ 基本訓練スクリプトの実装  
✅ 将来窓比較実験の実装  
✅ スライディングウィンドウ評価の実装  
✅ 時間的汎化性能評価の実装

### Week 2（予定）

🔜 Phase 1-2 の実験実行  
🔜 結果の分析・可視化  
🔜 Phase 3 の実装（ローリング評価）

### Week 3（予定）

🔜 Phase 2 の実験実行  
🔜 Phase 3 の実装（ローリング評価）  
🔜 Phase 3 の実験実行

### Week 4（予定）

🔜 Phase 4 の実装（層別分析）  
🔜 Phase 4 の実験実行  
🔜 統計分析・論文執筆

---

## 🛠️ 実装の優先度

### 最優先（Phase 1）✅ 完了

- スライディングウィンドウ評価
- RQ1 に直接答える
- 論文の主要な実験

### 高優先度（Phase 2）✅ 完了

- 時間的汎化性能評価
- RQ3 に答える
- 実用的な再訓練戦略の提案

### 中優先度（Phase 3）

- ローリングウィンドウ評価
- 性能の安定性を示す
- 季節性の影響を分析

### 低優先度（Phase 4）

- 層別分析
- RQ4 に答える
- より詳細な分析

---

## 📚 ドキュメント一覧

### 設計書

- `docs/IRL最終設計_学習期間内完結版.md` - 詳細設計
- `docs/IRL設計変更の要約.md` - 要約版
- `docs/将来的な比較実験の設計.md` - 実験設計の詳細
- `docs/実験ロードマップ.md` - **このファイル**

### 実験ガイド

- `scripts/training/irl/README_WITHIN_TRAINING_PERIOD.md` - 基本的な使い方
- `scripts/training/irl/README_EXPERIMENTS.md` - 実験ガイド
- `docs/スライディングウィンドウ評価ガイド.md` - Phase 1 の詳細
- `docs/時間的汎化性能評価ガイド.md` - Phase 2 の詳細

### 既存のドキュメント

- `README_TEMPORAL_IRL.md` - 既存の時系列 IRL 実装

---

## 🎉 まとめ

### 現在の状況

✅ **Phase 1 完了**: スライディングウィンドウ評価  
✅ **Phase 2 完了**: 時間的汎化性能評価  
✅ **基本機能**: 単一実験、将来窓比較  
✅ **可視化**: ヒートマップ、時系列プロット、比較グラフ

### 次のステップ

1. **Phase 1-2 を実行** → 実験データを取得
2. **最適設定を発見** → 論文の RQ1, RQ3 に答える
3. **Phase 3 を実装** → ローリングウィンドウ評価
4. **Phase 4 を実装** → 層別分析

### 論文への貢献

- ✅ 体系的な実験設計
- ✅ 網羅的な性能比較
- ✅ 再現可能な実装
- ✅ 実用的な推奨事項

---

**最終更新:** 2025-10-21  
**ステータス:** Phase 1-2 完了、Phase 3-4 設計完了
