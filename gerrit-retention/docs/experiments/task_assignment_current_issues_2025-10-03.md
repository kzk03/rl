# タスク中心 MDP — 現状の問題と解決方針（2025-10-03）

作成者: @kzk03

## 背景

- Reviewer sequences からタスク（Task× 候補レビュア）を生成し、`MultiReviewerAssignmentEnv`（reward_mode=match_gt）で学習/評価。
- eval は train と完全分離（cutoff > timestamp）で時間窓 1m/3m/6m/12m を評価。
- それにも関わらず、一致率（action match）が ≈98.5–98.7% と極めて高い。

## 症状（サマリ）

- eval の各窓で steps が十分大きいにも関わらず、一致率がほぼ一定かつ高止まり。
- 小規模データ時は steps が極小（窓にタスク無し）で不安定だったが、大規模化後も一致率は高いまま。

## 主な原因仮説

1. ポジショナル・バイアス（候補配列の先頭に正解が偏在）
   - 現行ビルダーは `cands = [rid] + (K-1の他者)` の順で生成。
   - positive_reviewer_ids は action==1 のとき `[rid]` になるため、候補 0（index 0）を選ぶだけで高一致になる恐れ。
2. 候補集合が易しすぎる（time-local のみ）
   - time-local（±60 日）で活動していた近傍者のみ → 正解者（rid）が常に含まれる上、負例が弱い（識別容易）。
3. 報酬設計が模倣的（match_gt）
   - 分類タスクに近く、複数正解がある場合は一致率が上がりやすい。
4. 特徴の自己同一性/連動
   - 候補別特徴は「候補 r の直前 state」を使うため、正解者にだけ強い特徴が現れている可能性。

## 直近の検証・観測

- eval で高一致（~0.986）。
- 大規模データへの切替後、窓ごとの steps は 2,284→18,890 と十分。一方で一致率はほぼ一定。
- 以上から、データ量不足ではなく設計上の易化要因が支配的と判断。

## 解決方針（段階別）

### A. バイアス除去（短期）

- 候補配列のシャッフル（タスクごと・seed 固定）
  - rid を含めつつ、位置はランダム化 → 位置学習の抜け道を遮断。
- 負例の強化（hard negatives）
  - 同プロジェクト/近接パス/過去接点ありの近傍者を優先的に候補へ → 認識難易度を上げる。
- 指標の追加
  - index ヒストグラム、Top-k（@k=3/5）、mAP、プロジェクト別/期間別の分解を導入。

### B. 問題設定の厳格化（中期）

- タスクソースの切替
  - reviewer_sequences ベースでは「正解=その人（rid）」になりがち。実 review request（owner→reviewer）由来のタスクに切替。
  - 候補集合はプロジェクト/パス親和・活動履歴で構成。
- 報酬の刷新
  - IRL 報酬（irl_softmax/accept_prob）へ切替し、分類的な match_gt のみから脱却。
  - 受諾確率/効用に基づく連続的報酬設計で過学習を検知しやすくする。

### C. フェア/リーク対策の強化（継続）

- 未来情報の混入チェック（再）
  - 候補別特徴はタスク時刻より前の最新 state のみに制限（実装済みだが改めて単体検証）。
- group-by（レビュア/メール）での分離評価（必要に応じて適用）。

## 具体アクション（ToDo）

- [x] ビルダー: `--shuffle-candidates` 追加（既定 ON）。タスクごとに候補シャッフル（seed 固定）。
- [ ] ビルダー: hard negatives 注入（同プロジェクト/過去近接/パス類似）オプション。
- [x] 評価: index0 正解率・平均候補数・ランダム Top-1 基準の監査指標を追加。
- [ ] 評価: index ヒスト・Top-k/mAP を `task_assignment_replay_eval.py` に追加。
- [ ] 監査: eval データで「candidate[0] が正解」の割合、「正解の候補出現率」、正解空タスク割合を集計するスクリプト追加。
- [ ] データ源切替: review request ベースのタスクビルダー（owner→reviewer）を新規実装。
- [ ] 報酬: IRL モデル（θ/スケーラ）連携の評価モードを追加。

## リスク/注意

- シャッフルにより短期的に一致率が低下する可能性（望ましい現象）。
- hard negatives の導入は計算負荷が増える（特徴計算コスト）。
- タスクソース切替には抽出処理の安定化（messages/reviewer_updates の整合）が必要。

## 検証計画（品質ゲート）

- Build/Lint/実行: すべてのスクリプトが例外なく通ること。
- 分布監査: 上記ヒスト/出現率の閾値にアラート（例: candidate[0]が正解 > 35% なら警告）。
- 指標: 一致率に加え Top-k/mAP/ECE を出力。時間窓・プロジェクト別での安定性確認。
- 再現: seed 固定（42）、窓・cutoff 一致を維持し、前後比較の差分を記録。

---

本メモは「高一致率の要因を除去し、より実運用に近い難易度で一般化性能を測る」ための方針を整理したものです。短期のシャッフル/監査で早急にバイアス除去を進め、中期で IRL 報酬と実タスク源へ移行します。
