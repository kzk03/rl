# スナップショット予測の仕組み: 正確な説明

## 📅 作成日
2025-10-30

## 🔍 ユーザーの質問

> 評価関数っていうのは何？？予測はスナップショットからn~mヶ月の期間でレビュー依頼があって承諾するかどうかを判断しているんですよね

## ✅ 正確な説明

### 用語の訂正

❌ **「評価関数」** という表現は誤りでした。

✅ **正しくは**: **「評価用の軌跡抽出関数」** （`extract_evaluation_trajectories`）

---

## 📊 スナップショット予測の流れ

### 1. 訓練時の処理

#### 時系列学習データ（`extract_training_trajectories`）

```
訓練期間: 2021-01-01 ～ 2023-01-01
  ├─ 特徴量計算期間: 2021-01-01 ～ 2023-01-01
  │   └─ 各月時点での特徴量を計算（時系列）
  │       ├─ 2021-01-01時点の特徴量 → ラベル（0-3m）
  │       ├─ 2021-02-01時点の特徴量 → ラベル（0-3m）
  │       ├─ ...
  │       └─ 2022-12-01時点の特徴量 → ラベル（0-3m）
  │
  └─ 全体ラベル期間: 2023-01-01 + (future_window)
      └─ 各レビュアーのラベル: この期間で承諾したか？
```

**特徴**:
- 時系列で学習（LSTMを使用）
- 各月時点での状態と行動を学習

### 2. 評価時の処理

#### スナップショット予測（`extract_evaluation_trajectories`）

```
Cutoff日: 2023-01-01

履歴期間: 2023-01-01 - 24ヶ月 ～ 2023-01-01
  └─ この期間の活動履歴から特徴量を計算（スナップショット）

評価期間: 2023-01-01 + (future_window)
  └─ この期間でレビュー依頼があって承諾したか？ → ラベル
```

#### `predict_continuation_probability_snapshot`

```python
def predict_continuation_probability_snapshot(
    developer: Dict[str, Any],
    activity_history: List[Dict[str, Any]],
    context_date: Optional[datetime] = None  # ← Cutoff日
) -> Dict[str, Any]:
    """
    スナップショット時点での継続確率を予測
    
    入力:
    - developer: 開発者データ
    - activity_history: 活動履歴（Cutoff日までの履歴）
    - context_date: Cutoff日（例: 2023-01-01）
    
    出力:
    - continuation_probability: 継続確率
    """
    # 1. Cutoff日時点での特徴量を計算（スナップショット）
    state = self.extract_developer_state(developer, activity_history, context_date)
    actions = self.extract_developer_actions(activity_history, context_date)
    
    # 2. 最新の行動を使用
    latest_action = actions[-1]
    
    # 3. 予測
    predicted_continuation = self.network(...)
    
    return {
        'continuation_probability': predicted_continuation,
        ...
    }
```

**重要な点**:
- **スナップショット**: Cutoff日時点での**単一時点**の特徴量
- **履歴の集約**: Cutoff日までの全履歴を集約して特徴量を計算
- **予測対象**: Cutoff日からfuture_window期間での承諾有無

---

## 🎯 質問への回答

> 予測はスナップショットからn~mヶ月の期間でレビュー依頼があって承諾するかどうかを判断しているんですよね

**✅ はい、その通りです！**

### 具体例

#### 設定
- Cutoff日: 2023-01-01
- 予測期間: 3～6ヶ月（future_window_start=3, future_window_end=6）

#### 処理の流れ

1. **スナップショット時点（2023-01-01）での特徴量計算**
   - 履歴期間（2021-01-01 ～ 2023-01-01）の活動を集約
   - 状態特徴量（10次元）を計算
   - 行動特徴量（4次元）を計算

2. **予測**
   - 訓練済みモデルに特徴量を入力
   - 継続確率（0～1）を出力

3. **ラベル（真の値）**
   - 評価期間（2023-04-01 ～ 2023-07-01）でレビュー依頼があったか？
   - 依頼があって承諾したか？（1 or 0）

4. **評価**
   - 予測確率と真のラベルを比較
   - AUC-PR, Precision, Recall, F1を計算

---

## 📋 訓練 vs 評価の違い

| 項目 | 訓練 | 評価 |
|------|------|------|
| **方法** | 時系列学習 | スナップショット予測 |
| **特徴量** | 各月時点での特徴量（複数時点） | Cutoff日時点での特徴量（単一時点） |
| **モデル** | LSTM（時系列を扱える） | 最終出力は状態+行動（単一時点） |
| **データリーク** | 訓練期間内でラベル計算 | Cutoff日以降でラベル計算 |

---

## 🔍 なぜ「評価関数」という用語を避けるべきか

### 誤解を招く表現

❌ **「評価関数」**
- 強化学習の報酬関数（reward function）と混同される
- メトリクス計算関数（evaluation function）と混同される

✅ **正しい表現**
- **「評価用の軌跡抽出」** （`extract_evaluation_trajectories`）
- **「スナップショット予測」** （`predict_continuation_probability_snapshot`）

### 正確な役割

| 関数名 | 役割 |
|--------|------|
| `extract_training_trajectories` | 訓練用軌跡を抽出（時系列） |
| `extract_evaluation_trajectories` | 評価用軌跡を抽出（スナップショット） |
| `predict_continuation_probability_snapshot` | スナップショット時点で予測 |

---

## 📊 まとめ

### 重要な理解

1. **訓練は時系列**
   - 各月時点での特徴量を学習
   - LSTMで時間的パターンを捉える

2. **評価はスナップショット**
   - Cutoff日時点での特徴量で予測
   - 履歴を集約して単一時点の特徴量として扱う

3. **予測対象**
   - Cutoff日からn～mヶ月期間でレビュー依頼があって承諾するか
   - ✅ ユーザーの理解は正確

### 用語の統一

| ❌ 誤り | ✅ 正しい |
|---------|----------|
| 評価関数 | 評価用軌跡抽出 |
| 評価期間の予測 | スナップショット予測 |

---

## 参考

- `src/gerrit_retention/rl_prediction/retention_irl_system.py`
  - `predict_continuation_probability_snapshot` (line 1393)
  - `extract_developer_state` (line 1150)
  - `extract_developer_actions` (line 1240)

- `scripts/training/irl/train_irl_review_acceptance.py`
  - `extract_evaluation_trajectories` (line 365)
  - `extract_training_trajectories` (line 95)

---

作成日: 2025-10-30

