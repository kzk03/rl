# 予測プロセスの詳細解説

## 予測プロセスの概要

本研究で提案する IRL ベースの開発者継続予測システムでは、学習済みモデルを使用して、特定の時点における開発者の継続確率を予測する。予測プロセスは以下のステップで構成される。

## 1. 入力データの準備

### 1.1 開発者データの取得

- **開発者基本情報**: メールアドレス、初回活動日、プロジェクト参加数
- **活動履歴**: コミット、レビュー、マージ等の時系列データ
- **基準日**: 予測を行う時点（context_date）

### 1.2 データの前処理

- 活動履歴を時系列順にソート
- 基準日以前のデータのみを抽出
- 欠損値の補完とデータの正規化

## 2. 特徴量抽出

### 2.1 状態特徴量の計算（9 次元）

開発者の現在の状態を表す特徴量を抽出：

**基本情報特徴量:**

- `experience_days`: 経験日数（初回活動日から基準日までの日数）
- `total_changes`: 累積変更数（総コミット数）
- `total_reviews`: 累積レビュー数
- `project_count`: 参加プロジェクト数

**活動パターン特徴量:**

- `recent_activity_frequency`: 最近の活動頻度（過去 30 日間の活動日数/30）
- `avg_activity_gap`: 平均活動間隔（活動タイムスタンプ間の平均日数）
- `activity_trend`: 活動トレンド（最近 30 日 vs 過去 30-60 日の活動量比較）

**協力・品質特徴量:**

- `collaboration_score`: 協力スコア（レビュー・マージ等の協力活動の割合）
- `code_quality_score`: コード品質スコア（test/doc/refactor/fix の頻度）

### 2.2 行動特徴量の計算（4 次元）

最近の行動を表す特徴量を抽出：

**行動の質的特徴量:**

- `intensity`: 行動の強度（変更行数ベース）
- `message_quality`: メッセージの質（fix, improve, test 等のキーワード含有率）
- `collaboration`: 協力度（レビューを通じた協力の程度）
- `latency`: 応答遅延（レビューリクエストから応答までの時間）

## 3. 特徴量の正規化

### 3.1 状態特徴量の正規化

各特徴量を 0-1 範囲に正規化：

- 経験日数: 年単位に変換（/365.0）
- 累積数値: 適切な係数で除算（/100.0, /10.0 等）
- 比率特徴量: 既に 0-1 範囲

### 3.2 行動特徴量の正規化

- 強度: ファイル数と変更行数に基づく正規化
- メッセージ品質: キーワード含有率の計算
- 協力度: 応答率等の比率計算
- 遅延: 日数単位での正規化

## 4. テンソル変換

### 4.1 状態テンソルの作成

```python
state_tensor = torch.tensor(state_features, dtype=torch.float32).unsqueeze(0)
# 形状: [1, 9] (バッチサイズ1, 状態次元9)
```

### 4.2 行動テンソルの作成

```python
action_tensor = torch.tensor(action_features, dtype=torch.float32).unsqueeze(0)
# 形状: [1, 4] (バッチサイズ1, 行動次元4)
```

## 5. ニューラルネットワークによる予測

### 5.1 ネットワークの構造

**エンコーダー層:**

- 状態エンコーダー: 9 次元 → 64 次元
- 行動エンコーダー: 4 次元 → 64 次元

**結合層:**

- 状態と行動の特徴量を結合（128 次元）

**予測層:**

- 報酬予測器: 128 次元 → 1 次元
- 継続確率予測器: 128 次元 → 1 次元（Sigmoid 活性化）

### 5.2 前向き計算（Forward Pass）

```python
# エンコーディング
state_encoded = state_encoder(state_tensor)
action_encoded = action_encoder(action_tensor)

# 結合
combined = torch.cat([state_encoded, action_encoded], dim=1)

# 予測
reward = reward_predictor(combined)
continuation_prob = continuation_predictor(combined)
```

## 6. 予測結果の処理

### 6.1 継続確率の計算

```python
continuation_prob = torch.sigmoid(continuation_prob_raw).item()
# 0.0-1.0の範囲で継続確率を出力
```

### 6.2 信頼度の計算

```python
confidence = min(abs(continuation_prob - 0.5) * 2, 1.0)
# 0.5からの距離に基づく信頼度（0.0-1.0）
```

### 6.3 理由生成

予測結果に基づいて、予測の根拠を生成：

- 高い継続確率の場合: 積極的な活動、協力行動等を指摘
- 低い継続確率の場合: 活動頻度の低下、協力不足等を指摘

## 7. 出力結果の構成

### 7.1 予測結果辞書

```python
{
    'continuation_probability': 0.75,  # 継続確率
    'confidence': 0.5,                # 信頼度
    'reasoning': "最近の活動頻度が高く...",  # 理由
    'method': 'inverse_reinforcement_learning',  # 手法名
    'state_features': [0.1, 0.2, ...],  # 状態特徴量
    'action_features': [0.3, 0.4, ...]  # 行動特徴量
}
```

### 7.2 結果の解釈

- **継続確率 > 0.7**: 高い継続可能性
- **継続確率 0.3-0.7**: 中程度の継続可能性
- **継続確率 < 0.3**: 低い継続可能性

## 8. 時系列予測モード

### 8.1 シーケンス予測

複数の時点での予測を行う場合：

**入力データの準備:**

- 状態シーケンス: [seq_len, 9]
- 行動シーケンス: [seq_len, 4]

**LSTM 処理:**

```python
# 各時点でのエンコーディング
state_encoded = state_encoder(state_sequence)
action_encoded = action_encoder(action_sequence)

# LSTM処理
lstm_out, _ = lstm(state_encoded + action_encoded)
hidden = lstm_out[:, -1, :]  # 最後の時点の隠れ状態

# 予測
continuation_prob = continuation_predictor(hidden)
```

### 8.2 可変長シーケンス対応

各開発者の活動履歴の長さが異なる場合：

- パディングによる長さ統一
- 実際の長さ情報（lengths）を LSTM に渡す
- マスク処理による無効な時点の除外

## 9. 予測の実行例

### 9.1 単一予測の実行

```python
# 開発者データと活動履歴を準備
developer = {
    'email': 'developer@example.com',
    'first_seen': '2023-01-01',
    'projects': ['nova', 'neutron']
}

activity_history = [
    {'type': 'commit', 'timestamp': '2023-01-15', 'message': 'Fix bug'},
    {'type': 'review', 'timestamp': '2023-01-20', 'score': 2}
]

# 予測実行
result = irl_system.predict_continuation_probability(
    developer, activity_history, context_date=datetime(2023, 2, 1)
)

# 結果: {'continuation_probability': 0.75, 'confidence': 0.5, ...}
```

### 9.2 バッチ予測の実行

複数の開発者に対する予測：

```python
results = []
for developer in developers:
    result = irl_system.predict_continuation_probability(developer, history)
    results.append(result)
```

## 10. 予測性能の評価

### 10.1 評価指標

- **AUC-ROC**: 全体的な分類性能
- **AUC-PR**: 不均衡データでの性能
- **Precision**: 偽陽性の抑制度合い
- **Recall**: 真陽性の検出率
- **F1-Score**: Precision と Recall の調和平均

### 10.2 予測結果の検証

- 実際の継続・離脱ラベルとの比較
- 予測確率の分布分析
- 信頼度と予測精度の関係分析

この予測プロセスにより、開発者の継続可能性を定量的に評価し、プロジェクト管理における意思決定を支援することができる。
