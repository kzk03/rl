# 時間的汎化性能評価ガイド（Phase 2）

## 📋 概要

訓練後の**時間経過による性能劣化**を分析し、再訓練のタイミングを推奨します。

---

## 🎯 目的

### 研究課題（RQ3）

**「モデルの時間的汎化性能は？再訓練はいつ必要か？」**

### 評価内容

```python
訓練期間: 2019-01-01 ～ 2020-01-01（固定）

評価期間:
  1. 2020-01-01 ～ 2020-07-01  (+0-6ヶ月)
  2. 2020-07-01 ～ 2021-01-01  (+6-12ヶ月)
  3. 2021-01-01 ～ 2021-07-01  (+12-18ヶ月)
  4. 2021-07-01 ～ 2022-01-01  (+18-24ヶ月)
```

---

## 🚀 クイックスタート

### 基本的な実行

```bash
# デフォルト設定で実行（4評価期間、6ヶ月間隔）
./scripts/training/irl/run_temporal_generalization.sh
```

### カスタム設定

```bash
uv run python scripts/training/irl/evaluate_temporal_generalization.py \
  --reviews data/review_requests_openstack_multi_5y_detail.csv \
  --train-start 2019-01-01 \
  --train-end 2020-01-01 \
  --eval-interval-months 6 \
  --num-eval-periods 4 \
  --history-window 6 \
  --future-window-start 0 \
  --future-window-end 1 \
  --epochs 30 \
  --sequence \
  --output outputs/temporal_generalization
```

---

## 📊 出力結果

### ディレクトリ構造

```
outputs/temporal_generalization/
├── irl_model.pth                          # 訓練済みモデル
├── temporal_generalization_results.json   # 全結果（JSON）
├── temporal_generalization_metrics.csv    # メトリクスCSV
└── temporal_generalization_plot.png       # 時系列プロット
```

---

## 📈 結果の見方

### 1. 時系列プロット

**4 つのグラフ:**

#### (1) AUC-ROC の推移

```
AUC-ROC
 0.85 |●
      |  ●
 0.80 |    ●
      |      ●
 0.75 |________●_______
      0  6  12  18  24 (months after training)
```

#### (2) AUC-PR の推移

#### (3) F1 Score の推移

#### (4) 劣化率

```
劣化率 (%)
   0 |●________
     |    ●
  -5 |        ●________
     |            ●
 -10 |________________
      0  6  12  18  24 (months after training)

  5%劣化ライン  ------ (警告)
 10%劣化ライン  ------ (要再訓練)
```

---

### 2. コンソール出力（サマリー）

```
================================================================================
時間的汎化性能評価
================================================================================

訓練期間: 2019-01-01 ～ 2020-01-01
評価期間数: 4

--------------------------------------------------------------------------------
各評価期間の性能
--------------------------------------------------------------------------------
評価期間                                    AUC-ROC     AUC-PR         F1    サンプル
--------------------------------------------------------------------------------
2020-01-01 ～ 2020-07-01                      0.852      0.789      0.687       1234
2020-07-01 ～ 2021-01-01                      0.843      0.776      0.672       1189
2021-01-01 ～ 2021-07-01                      0.821      0.751      0.645       1145
2021-07-01 ～ 2022-01-01                      0.798      0.728      0.619       1098
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
性能劣化のサマリー
--------------------------------------------------------------------------------

初期性能（最初の評価期間）:
  AUC-ROC: 0.852
  AUC-PR:  0.789
  F1:      0.687

最終性能（最後の評価期間）:
  AUC-ROC: 0.798
  AUC-PR:  0.728
  F1:      0.619

劣化率:
  AUC-ROC:    6.3%
  AUC-PR:     7.7%
  F1:         9.9%

統計:
  平均 AUC-ROC: 0.829 ± 0.023

--------------------------------------------------------------------------------
推奨事項
--------------------------------------------------------------------------------
⚠️  性能劣化が見られる（5-10%）。6ヶ月以内に再訓練を推奨。
================================================================================
```

---

### 3. 推奨事項の判定基準

| 劣化率 | 判定 | 推奨アクション           |
| ------ | ---- | ------------------------ |
| < 5%   | ✅   | 継続使用可能             |
| 5-10%  | ⚠️   | 6 ヶ月以内に再訓練を推奨 |
| > 10%  | ❌   | すぐに再訓練が必要       |

---

## 🔬 実験パターン

### パターン 1: デフォルト（6 ヶ月間隔）

```bash
--eval-interval-months 6
--num-eval-periods 4

# 評価期間:
# +0-6m, +6-12m, +12-18m, +18-24m
```

**用途:** 標準的な評価、論文の主実験

---

### パターン 2: 密な評価（3 ヶ月間隔）

```bash
--eval-interval-months 3
--num-eval-periods 8

# 評価期間:
# +0-3m, +3-6m, +6-9m, +9-12m, ...
```

**用途:** より詳細な劣化パターンの分析

---

### パターン 3: 長期評価（12 ヶ月間隔）

```bash
--eval-interval-months 12
--num-eval-periods 3

# 評価期間:
# +0-12m, +12-24m, +24-36m
```

**用途:** 超長期的な汎化性能の評価

---

### パターン 4: 手動指定

```bash
--eval-periods "2020-01-01,2020-04-01" \
               "2020-04-01,2020-07-01" \
               "2020-07-01,2020-10-01" \
               "2020-10-01,2021-01-01"
```

**用途:** 特定の期間を評価

---

## 📝 実験例

### 実験 1: 標準評価

```bash
uv run python scripts/training/irl/evaluate_temporal_generalization.py \
  --reviews data/review_requests_openstack_multi_5y_detail.csv \
  --train-start 2019-01-01 \
  --train-end 2020-01-01 \
  --eval-interval-months 6 \
  --num-eval-periods 4 \
  --output outputs/temporal_gen_standard
```

**期待:** 6 ヶ月後から劣化開始

---

### 実験 2: 既存モデルを使用

```bash
# すでに訓練済みのモデルがある場合
uv run python scripts/training/irl/evaluate_temporal_generalization.py \
  --model outputs/irl_best/irl_model.pth \
  --reviews data/review_requests_openstack_multi_5y_detail.csv \
  --train-start 2019-01-01 \
  --train-end 2020-01-01 \
  --output outputs/temporal_gen_existing_model
```

**利点:** 訓練時間を節約

---

## 📊 論文での活用

### Figure: 時間的汎化性能の推移

```markdown
![時間的汎化性能](outputs/temporal_generalization/temporal_generalization_plot.png)

_図: 訓練後の時間経過による性能推移。
AUC-ROC は訓練直後の 0.852 から 24 ヶ月後には 0.798 に低下（劣化率 6.3%）。_
```

---

### Table: 評価期間ごとの性能

| 評価期間（訓練後） | AUC-ROC | AUC-PR | F1    | サンプル |
| ------------------ | ------- | ------ | ----- | -------- |
| 0-6 ヶ月           | 0.852   | 0.789  | 0.687 | 1234     |
| 6-12 ヶ月          | 0.843   | 0.776  | 0.672 | 1189     |
| 12-18 ヶ月         | 0.821   | 0.751  | 0.645 | 1145     |
| 18-24 ヶ月         | 0.798   | 0.728  | 0.619 | 1098     |

---

### 発見事項の記述例

**RQ3: モデルの時間的汎化性能は？**

> 時間的汎化性能評価により、訓練後 24 ヶ月間にわたる性能推移を分析した結果、AUC-ROC は訓練直後の 0.852 から 24 ヶ月後には 0.798 に低下し、6.3%の性能劣化が観測された。
>
> 劣化は線形的ではなく、訓練後 6-12 ヶ月で緩やかに始まり、12 ヶ月以降に加速する傾向が見られた。この結果は、**6 ヶ月ごとの再訓練**が性能維持に有効であることを示唆している。

---

## ⚙️ パラメータ詳細

### 必須パラメータ

| パラメータ      | 説明             |
| --------------- | ---------------- |
| `--reviews`     | レビューログ CSV |
| `--train-start` | 訓練期間の開始日 |
| `--train-end`   | 訓練期間の終了日 |

### 評価期間設定

| パラメータ               | デフォルト | 説明                         |
| ------------------------ | ---------- | ---------------------------- |
| `--eval-interval-months` | `6`        | 評価期間の間隔（ヶ月）       |
| `--num-eval-periods`     | `4`        | 評価期間の数                 |
| `--eval-periods`         | なし       | 手動指定（"開始,終了" 形式） |

### ウィンドウ設定

| パラメータ              | デフォルト | 説明                   |
| ----------------------- | ---------- | ---------------------- |
| `--history-window`      | `6`        | 履歴ウィンドウ（ヶ月） |
| `--future-window-start` | `0`        | 将来窓の開始（ヶ月）   |
| `--future-window-end`   | `1`        | 将来窓の終了（ヶ月）   |

### モデル設定

| パラメータ   | 説明                                         |
| ------------ | -------------------------------------------- |
| `--model`    | 既存モデルのパス（指定しない場合は新規訓練） |
| `--epochs`   | 訓練エポック数（デフォルト: 30）             |
| `--sequence` | 時系列モード（LSTM）を有効化                 |
| `--seq-len`  | シーケンス長（デフォルト: 15）               |

---

## 🐛 トラブルシューティング

### データが足りない

**原因:** 評価期間が長すぎる

**解決策:**

```bash
# 評価期間を短くする
--eval-interval-months 3  # 6 → 3ヶ月
--num-eval-periods 3      # 4 → 3期間
```

---

### 劣化が見られない

**原因:** データが静的、または期間が短い

**解決策:**

```bash
# より長期間で評価
--eval-interval-months 12
--num-eval-periods 3  # 36ヶ月分
```

---

## 📚 関連ドキュメント

- **実験ロードマップ**: `docs/実験ロードマップ.md`
- **Phase 1**: `docs/スライディングウィンドウ評価ガイド.md`
- **基本訓練**: `scripts/training/irl/README_WITHIN_TRAINING_PERIOD.md`

---

## 🎉 次のステップ

### Phase 2 完了後

✅ 時間的汎化性能評価  
→ **Phase 3**: ローリングウィンドウ評価  
→ **Phase 4**: 層別分析

### 論文執筆

1. 実験を実行
2. 時系列プロットを分析
3. 劣化率を計算
4. 再訓練戦略を提案
5. RQ3 に答える

---

**作成日:** 2025-10-21  
**ステータス:** Phase 2 実装済み
