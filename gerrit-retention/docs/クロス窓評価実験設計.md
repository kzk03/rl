# クロス窓評価実験 設計書

**作成日**: 2025年10月23日

---

## 🎯 実験目的

訓練時のラベル期間と評価時の予測期間を変えて、**モデルの汎化性能**を評価する。

### 研究課題

1. 短期ラベルで訓練したモデルは長期予測ができるか？
2. 長期ラベルで訓練したモデルは短期予測にも有効か？
3. 訓練期間と評価期間が一致する場合が最良か？

---

## 📊 実験設計

### マトリクス構成

**5 × 4 = 20モデル**

| 訓練ラベル ＼ 評価期間 | 0-3m | 3-6m | 6-9m | 9-12m |
|-------------------|------|------|------|-------|
| **0-1m**          | ✓    | ✓    | ✓    | ✓     |
| **0-3m**          | ✓    | ✓    | ✓    | ✓     |
| **0-6m**          | ✓    | ✓    | ✓    | ✓     |
| **0-9m**          | ✓    | ✓    | ✓    | ✓     |
| **0-12m**         | ✓    | ✓    | ✓    | ✓     |

---

## 🔍 訓練ラベルと評価期間の定義

### 訓練ラベル（5種類）- 累積期間

各タイムステップから将来の累積期間内に貢献があるかをラベル付け。

1. **0-1m**: スナップショットから0～1ヶ月後の間に貢献？
2. **0-3m**: スナップショットから0～3ヶ月後の間に貢献？
3. **0-6m**: スナップショットから0～6ヶ月後の間に貢献？
4. **0-9m**: スナップショットから0～9ヶ月後の間に貢献？
5. **0-12m**: スナップショットから0～12ヶ月後の間に貢献？

### 評価期間（4種類）- スライディング期間

Cutoff時点から特定の期間範囲内に貢献があるかを予測。

1. **0-3m**: スナップショットから0～3ヶ月後の間に貢献？
2. **3-6m**: スナップショットから3～6ヶ月後の間に貢献？
3. **6-9m**: スナップショットから6～9ヶ月後の間に貢献？
4. **9-12m**: スナップショットから9～12ヶ月後の間に貢献？

---

## 📝 具体例

### 例1: 訓練ラベル 0-3m で訓練 → 評価期間 3-6m で予測

#### 訓練フェーズ

**レビュアーAの活動履歴（seq_len=50）**:

```
ステップ1  (2022-01-05):  この時点から0-3m後に貢献？ → ラベル: Yes
ステップ2  (2022-01-20):  この時点から0-3m後に貢献？ → ラベル: No
ステップ3  (2022-02-15):  この時点から0-3m後に貢献？ → ラベル: Yes
...
ステップ50 (2022-12-15): この時点から0-3m後に貢献？ → ラベル: Yes
```

- **50個のラベル**でLSTMを訓練
- 「各時点から0-3m後の継続パターン」を学習

#### 評価フェーズ

**2023-01-01時点の開発者**:

```
Cutoff時点 (2023-01-01)
過去12ヶ月の活動履歴（最新50個）を入力
↓
予測: 2023-01-01から3-6m後（2023-04-01～2023-07-01）に貢献？
```

- **訓練とは異なる期間**を予測（クロス評価）
- 訓練: 0-3m後のパターンを学習
- 評価: 3-6m後を予測

### 例2: 訓練ラベル 0-1m で訓練 → 評価期間 9-12m で予測

**訓練**: 短期ラベル(0-1m)でパターンを学習  
**評価**: 長期予測(9-12m)を試す  
**問い**: 短期パターンで長期を予測できるか？

---

## 🔬 期待される発見

### 仮説1: 対角線付近が最良？

```
訓練ラベル 0-3m → 評価期間 0-3m: 高性能？
訓練ラベル 0-6m → 評価期間 3-6m: 高性能？
```

訓練期間と評価期間が一致または近い場合、性能が最も良いと予想。

### 仮説2: 短期訓練→長期予測は可能？

```
訓練ラベル 0-1m → 評価期間 9-12m: 性能は？
訓練ラベル 0-3m → 評価期間 9-12m: 性能は？
```

短期的なパターンだけで長期的な継続性を予測できるか？

### 仮説3: 長期訓練→短期予測は有効？

```
訓練ラベル 0-12m → 評価期間 0-3m: 性能は？
訓練ラベル 0-9m  → 評価期間 0-3m: 性能は？
```

長期的なパターンは短期予測にも役立つか、それとも過学習？

---

## ⚙️ 実装詳細

### データ設定

```yaml
データソース: data/review_requests_openstack_multi_5y_detail.csv
学習期間: 2021-01-01 ～ 2023-01-01 (2年間)
評価開始: 2023-01-01
評価終了: 2025-10-01
```

### モデル設定

```yaml
seq_len: 50               # 使用する活動数（最新50個）
履歴ウィンドウ: 12ヶ月    # 過去12ヶ月の活動を考慮
エポック: 50
hidden_dim: 128
learning_rate: 0.0001
```

### 重要な実装特徴

✅ **実際の活動タイムスタンプを使用**
- 人工的な等間隔配置ではない
- 実際の開発者の活動リズムを反映

✅ **各タイムステップでラベル付け**
- seq_len=50 → 50個のラベルで学習
- LSTMが時系列パターンを学習

✅ **レビュアーごとに処理**
- 個別の開発者ごとに軌跡を抽出
- サンプリング時点: 12ヶ月間で毎月1回

---

## 📈 評価指標

各モデルで以下を測定:

- **AUC-ROC**: 識別性能（ランダム=0.5）
- **AUC-PR**: 不均衡データでの性能
- **F1 Score**: Precision と Recall のバランス
- **Precision**: 予測した継続者のうち実際に継続した割合
- **Recall**: 実際の継続者のうち正しく予測できた割合
- **Optimal Threshold**: F1を最大化する閾値
- **Continuation Rate**: データの継続率（データバランス確認）

---

## 📁 出力ファイル構成

```
outputs/cross_window_evaluation/
├── train_0-1m_eval_0-3m/
│   ├── irl_model.pt          # 訓練済みモデル
│   ├── metrics.json          # 評価指標
│   ├── training.log          # 訓練ログ
│   ├── train_trajectories.pkl
│   └── eval_trajectories.pkl
├── train_0-1m_eval_3-6m/
├── train_0-1m_eval_6-9m/
├── train_0-1m_eval_9-12m/
├── train_0-3m_eval_0-3m/
...（全20モデル）
├── train_0-12m_eval_9-12m/
├── cross_evaluation_results.csv       # 全結果の一覧
└── cross_window_evaluation_heatmaps.png  # 5×4マトリクス可視化
```

---

## ⏱️ 推定所要時間

- **1モデル**: 10-15分
- **全20モデル**: 3-5時間

---

## 🚀 実行方法

### バッチ実行

```bash
bash scripts/training/irl/run_cross_window_evaluation.sh
```

### 結果の可視化

```bash
# 実行完了後
uv run python scripts/training/irl/visualize_cross_window_evaluation.py
```

---

## 📊 可視化出力

### ヒートマップ（5×4マトリクス）

各評価指標（AUC-ROC, F1, Precision, Recall）について：
- 行: 訓練ラベル（0-1m, 0-3m, 0-6m, 0-9m, 0-12m）
- 列: 評価期間（0-3m, 3-6m, 6-9m, 9-12m）
- セルの色: 性能の高低

### ラインプロット

各訓練ラベルごとに、評価期間を変えたときの性能推移を可視化。

---

## 🔍 分析の観点

### 対角線の分析

訓練期間と評価期間が近い場合（対角線付近）の性能を確認。

### オフ対角線の分析

**上三角（短期→長期）**:
- 短期訓練ラベルで長期予測が可能か？

**下三角（長期→短期）**:
- 長期訓練ラベルが短期予測にも有効か？

### 行ごとの分析

同じ訓練ラベルで、評価期間を変えたときの性能変化。

### 列ごとの分析

同じ評価期間で、訓練ラベルを変えたときの性能変化。

---

## 💡 実験の意義

### 実用的な価値

1. **最適な訓練戦略の発見**
   - どの期間のラベルで訓練すれば汎用性が高いか？

2. **予測可能な期間範囲の特定**
   - 短期訓練でどこまで長期予測できるか？

3. **データ収集の最適化**
   - 限られたラベルデータで最大の効果を得る方法

### 学術的な貢献

1. **時系列パターンの汎化性**
   - 異なる時間窓での開発者行動パターンの類似性

2. **継続性予測の時間依存性**
   - 短期・中期・長期の継続性は異なるパターンか？

3. **転移学習の可能性**
   - ある期間で学習したモデルが他の期間にも適用可能か？

---

## 📚 関連ドキュメント

- [IRL学習と予測の完全ガイド](./IRL学習と予測の完全ガイド.md)
- [LSTM時系列学習の修正](./LSTM時系列学習の修正.md)
- [seq_len最適化実験結果](./seq_len最適化実験結果.md)

---

## 📝 更新履歴

- **2025-10-23**: 初版作成
  - 実装を修正（実際の活動タイムスタンプを使用）
  - 訓練ラベル: 累積期間（0-1m, 0-3m, 0-6m, 0-9m, 0-12m）
  - 評価期間: スライディング期間（0-3m, 3-6m, 6-9m, 9-12m）
  - 5×4 = 20モデルのマトリクス評価

