# 同一プロジェクト継続判定への修正

## 概要

2025-10-26: 複数プロジェクトでの実行時も、**同一プロジェクト内での継続のみ**を判定するように修正しました。

---

## 背景

### 修正前の動作

**複数プロジェクト実行:**

- レビュアー A さんが`openstack/nova`で活動
- 将来`openstack/neutron`で活動
- → **「継続」と判定** ✓

**nova 単一実行:**

- レビュアー A さんが`openstack/nova`で活動
- 将来`openstack/neutron`で活動
- → **「非継続」と判定** ✗

### 問題点

- 複数プロジェクトと nova 単一で継続率が大きく異なる
  - 複数プロジェクト: 61.5% (0-3m)
  - nova 単一: 46.8% (0-3m)
  - 差分: **-14.7pt**
- この差は「プロジェクト間移動」を含むか否かの違い
- 比較が不公平

---

## 修正内容

### 新しいロジック

1. **履歴期間内で活動しているプロジェクトを取得**

   ```python
   history_projects = set(reviewer_history_sorted['project'].dropna().unique())
   ```

2. **将来活動を、履歴期間内のプロジェクトに限定**
   ```python
   future_activities = reviewer_all_activities[
       (reviewer_all_activities[date_col] >= future_start) &
       (reviewer_all_activities[date_col] < future_end) &
       (reviewer_all_activities['project'].isin(history_projects))  # ← 追加
   ]
   ```

### 修正対象ファイル

- `scripts/training/irl/train_irl_within_training_period.py`

### 修正対象関数

1. **`extract_full_sequence_monthly_label_trajectories`** (318-345 行目)

   - 全シーケンス + 月次集約ラベル
   - 最も重要な関数

2. **`extract_monthly_aggregated_label_trajectories`** (524-536 行目)

   - サンプリング時点ベースのラベル

3. **`extract_cutoff_evaluation_trajectories`** (906-914 行目)

   - 評価用軌跡抽出

4. **`extract_multi_step_label_trajectories`** (721-735 行目)

   - 各タイムステップラベル

5. **`extract_temporal_trajectories_within_training_period`** (179-187 行目)
   - 古い関数（一貫性のため修正）

---

## 動作確認

### 修正後の動作

**複数プロジェクト実行:**

- レビュアー A さんが`openstack/nova`で活動
- 将来`openstack/neutron`で活動
- → **「非継続」と判定** ✓

**nova 単一実行:**

- レビュアー A さんが`openstack/nova`で活動
- 将来`openstack/neutron`で活動
- → **「非継続」と判定** ✓

**両方とも同じ基準で判定！**

---

## 期待される影響

### 継続率の変化

**複数プロジェクト（修正前 → 修正後）:**

- 0-3m: 61.5% → **減少が予想**（おそらく 46-50%程度）
- 理由: プロジェクト間移動が「非継続」になるため

**nova 単一（変化なし）:**

- 0-3m: 46.8% → **変化なし**
- 理由: 元々 nova 内のみで判定していた

### モデル性能への影響

- **AUC-ROC**: 複数プロジェクトで**低下**する可能性
- **F1 スコア**: 継続率が変わるため変化する可能性
- **公平な比較**: 複数プロジェクト vs nova 単一の比較が公平になる

---

## ログメッセージの更新

すべての対象関数に以下のログメッセージを追加：

```python
logger.info("継続判定: 履歴期間内のプロジェクトでの継続のみをカウント")
```

これにより、実行時に継続判定の基準が明確になります。

---

## 次のステップ

### 1. 検証実行

```bash
# 複数プロジェクトでテスト実行（短いepoch）
uv run python scripts/training/irl/train_irl_per_timestep_labels.py \
    --reviews data/review_requests_openstack_multi_5y_detail.csv \
    --train-start 2021-01-01 \
    --train-end 2023-01-01 \
    --eval-start 2023-01-01 \
    --eval-end 2024-01-01 \
    --future-window-start 0 \
    --future-window-end 3 \
    --epochs 5 \
    --use-full-sequence \
    --output outputs/test_same_project
```

### 2. 継続率の確認

実行ログから以下を確認：

```
継続判定: 履歴期間内のプロジェクトでの継続のみをカウント
レビュアー単位継続率: XX.X%
```

### 3. 完全再実行（オプション）

もし必要であれば、複数プロジェクトでの完全クロス評価を再実行：

```bash
bash scripts/training/irl/run_full_cross_evaluation.sh
```

---

## 技術的詳細

### プロジェクトセットの扱い

- **履歴期間内のプロジェクト**: レビュアーが過去 12 ヶ月（履歴ウィンドウ）に活動したプロジェクトのセット
- **将来活動の判定**: このプロジェクトセット内での活動のみをカウント
- **複数プロジェクトに活動**: 履歴期間内に複数プロジェクトで活動していた場合、それら全てで将来活動をチェック

### エッジケース

**ケース 1: 履歴期間内に複数プロジェクト**

```
履歴: nova (5回), neutron (2回)
将来: nova (1回)
→ 「継続」（nova での継続）

将来: neutron (1回)
→ 「継続」（neutron での継続）

将来: cinder (1回)
→ 「非継続」（cinder は履歴になし）
```

**ケース 2: プロジェクト情報がない**

```python
history_projects = set(reviewer_history_sorted['project'].dropna().unique())
```

- `dropna()`で欠損値を除外
- 欠損値がある場合でも動作する

---

## 関連ドキュメント

- `docs/nova単一プロジェクト実行記録.md`: nova 単一実行の詳細
- `docs/完全クロス評価ガイド.md`: 完全クロス評価の実行方法
- `CLAUDE.md`: 開発履歴

---

## 変更日時

- **修正日**: 2025-10-26
- **修正者**: AI（Claude）
- **修正理由**: 複数プロジェクト vs 単一プロジェクトの公平な比較を実現
