## 現状サマリ（2025-09-29）

本プロジェクトは「レビュー依頼（owner→reviewer のアサイン）」に対して、指定期間内（既定 14 日）にレビュアーが反応（コメント or 投票）するかを予測するパイプラインを構築・評価しています。フェアでリークの少ない評価（時間分割＋メール単位グルーピング＋ギャップ特徴除外）を基本ポリシーにしています。

### いまの結論・ハイライト

- パイロット（OpenStack 一部、1,670 行）で、グローバルな owner↔reviewer 近接メッセージ特徴（±D 日以内の相互メッセージ）を入れると ROC-AUC がベースライン（約 0.518）から 0.541 付近まで上昇。
- プロジェクト別やペア割当履歴、レビュアー負荷・代理応答率の追加は AUC は横ばい〜微減、AP がやや改善するケースあり（データ規模の影響が大きい可能性）。
- 本日、ファイルパスの「馴染み」特徴（過去 180 日でレビュアーが担当した変更のファイル・ディレクトリと、今回の変更の重なり/Jaccard）をビルダーに実装完了。これを用いた再評価は未実施（次アクション）。

## 目的と設定

- 目的: 介入前（no-intervention）状態で、レビュー依頼に対する「反応有無」を確率予測。
- ラベリング（可変）: message / vote-only / vote-or-message（既定は message）。
- 評価指標: ROC-AUC, AP, Brier, ECE。分割は時間ベース、メール（reviewer_email）でグループ化。ギャップ系特徴は除外可能（リーク抑制）。

## 実装状況（主要コンポーネント）

### データ抽出・統合

- Gerrit クライアントの安定化（未サポートオプション削除、reviewers 専用エンドポイントの追加）。
- 変更（Change）の詳細(JSON)から per-review-request データセットを構築。

### 特徴量（per-review-request）

- 活動量（過去 30/90/180 日コメント数、オーナー側コメント数）
- 近接相互作用（owner↔reviewer メッセージの ±D 日近接数、グローバル/プロジェクト別）
- ペア履歴（owner→reviewer 過去割当 180 日）
- レビュアー負荷（過去 7/30/180 日の割当数）、代理応答率（180 日：過去レビュー数/割当数、クリップ）
- 変更の複雑度（挿入/削除/ファイル数）、WIP、件名長、在籍（tenure）
- 反応タイプ切替（message, vote-only, vote-or-message）と投票の最初の反応時間
- 新規: パス馴染み（過去 180 日のレビュアー担当変更との重なり）
  - files（フルパス集合）/ dir1（一階層）/ dir2（二階層）について、以下を算出（グローバル/プロジェクト別）
    - path*overlap*{files,dir1,dir2}\_{global,project}
    - path*jaccard*{files,dir1,dir2}\_{global,project}

### 評価パイプライン

- 時間分割、group-by-email、ギャップ特徴除外に対応。
- モデルは sklearn ベースのアンサンブル（RF/XGB/MLP）に対応し、確率抽出の堅牢化あり（オプション依存関係は存在すれば使用）。

## 直近の主な変更（今日まで）

1. 近接相互作用（グローバル ±D 日）の導入 → AUC 改善を確認。
2. プロジェクト別相互作用、ペア割当履歴、負荷・代理応答率の拡充 → AP 改善傾向、AUC は微変。
3. ラベリングの切替（message/vote-only/vote-or-message）と投票反応時間の取り込み。
4. パス馴染みの実装完了（examples/build_eval_from_review_requests.py）
   - 各変更の current_revision からファイル集合を前計算
   - レビュアー →(割当時刻, change_id, project) のインデックス化
   - 割当時点で過去 180 日における担当変更のファイル/dir1/dir2 の集合をユニオンし、今回変更との重なり・Jaccard を算出（グローバル/同一プロジェクト）

注: 手元で `examples/real_data_evaluate.py` と `src/gerrit_retention/prediction/retention_predictor.py` にユーザー側の手修正が入っています。新しいパス特徴の「評価側パススルー」と「モデル側取り込み」は次アクションで衝突がないよう現状を確認してから対応します。

## 指標スナップショット（パイロット）

- ベースライン（ギャップ除外）: ROC-AUC ≈ 0.518
- 近接相互作用（グローバル ±D=14）:
  - ROC-AUC 0.5409, AP 0.0861, Brier 0.0648, ECE 0.0344
- プロジェクト/ペア/負荷（第一弾）:
  - ROC-AUC 0.5273, AP 0.0777, Brier 0.0663, ECE 0.0346
- 180 日負荷＋代理応答率追加:
  - ROC-AUC 0.5230, AP 0.0985, Brier 0.0656, ECE 0.0322

所感: データが小さく変動が大きい一方、相互作用と「馴染み」系は有望。より長期・複数プロジェクトの拡大が安定化に必要。

## 未完了タスクと次アクション

1. パス特徴のパススルー（評価側）
   - `examples/real_data_evaluate.py` に新規 path\_\* 列をモデル入力へ渡す処理を追加。
2. パス特徴のモデル取り込み
   - `src/gerrit_retention/prediction/retention_predictor.py` の特徴抽出に path\_\* を追加（必要に応じて log1p 等の安全変換）。
3. 再ビルド・再評価
   - パス特徴入り CSV を再生成し、フェア設定（時間分割・メールグループ化・ギャップ除外）で評価。
4. データ拡大
   - 期間 6〜12 ヶ月、多プロジェクト化、vote-only ラベルでも評価。
5. ハイパラ・窓幅アブレーション
   - 近接窓（±7/14/21/28）、履歴窓（90/180/365）のスイープ。

## 既知の制約・注意

- 一部のオプション依存（例: XGBoost/SHAP）は環境に無ければ自動フォールバック。
- 小規模データでは AUC/AP の分散が大きい可能性。時間分割と厳格な事前フィルタでリークを抑制しているが、さらなるデータ拡充が望ましい。

---

本ドキュメントは 2025-09-29 時点の状況です。次の評価結果が出次第、更新します。
