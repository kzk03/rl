# クロス評価実行ガイド

**全シーケンス＋月次集約ラベルでのクロス評価**

---

## 🚀 クイックスタート

### 1. 実行コマンド

```bash
cd /Users/kazuki-h/rl/gerrit-retention
bash scripts/training/irl/run_cross_evaluation_simple.sh
```

### 2. バックグラウンド実行（推奨）

```bash
cd /Users/kazuki-h/rl/gerrit-retention
bash scripts/training/irl/run_cross_evaluation_simple.sh > /tmp/cross_eval.log 2>&1 &
```

### 3. 進捗確認

```bash
# ログ監視
tail -f /tmp/cross_eval.log

# 完了したモデルの確認
ls -lh outputs/cross_eval_simple/*/metrics.json

# メトリクスの確認
cat outputs/cross_eval_simple/train_eval_0-3m/metrics.json | python -m json.tool
```

### 4. 結果集計

```bash
uv run python scripts/training/irl/summarize_cross_evaluation.py outputs/cross_eval_simple
```

---

## ⚙️ 実験設定

### データ設定

```yaml
学習期間: 2021-01-01 ～ 2023-01-01 (2年間)
評価期間: 2023-01-01 ～ 2024-01-01 (1年間)
履歴窓: 12ヶ月
データ: data/review_requests_openstack_multi_5y_detail.csv
```

### モデル設定

```yaml
エポック数: 20
訓練ラベル:
  - 0-1m: cutoff後0-1ヶ月以内に貢献
  - 0-3m: cutoff後0-3ヶ月以内に貢献
  - 0-6m: cutoff後0-6ヶ月以内に貢献
  - 0-9m: cutoff後0-9ヶ月以内に貢献
  - 0-12m: cutoff後0-12ヶ月以内に貢献

サンプリング: なし（全シーケンス）
シーケンス長: 可変長（全活動履歴）
ラベル: 月次集約
```

### 予想実行時間

```
1モデル: 約15分（エポック20）
合計: 約75分（5モデル）
```

---

## 📊 出力ファイル構造

```
outputs/cross_eval_simple/
├── train_eval_0-1m/
│   ├── irl_model.pt              # 学習済みモデル
│   ├── metrics.json              # 評価メトリクス
│   ├── training.log              # 訓練ログ
│   ├── train_trajectories.pkl    # 訓練データ
│   └── eval_trajectories.pkl     # 評価データ
├── train_eval_0-3m/
│   └── ... (同様)
├── train_eval_0-6m/
│   └── ... (同様)
├── train_eval_0-9m/
│   └── ... (同様)
├── train_eval_0-12m/
│   └── ... (同様)
└── summary.csv                    # 集計結果
```

---

## 📈 結果の見方

### metrics.json の内容

```json
{
  "auc_roc": 0.74, // ROC曲線下面積（高いほど良い）
  "auc_pr": 0.849, // PR曲線下面積（高いほど良い）
  "precision": 0.825, // 精度
  "recall": 0.588, // 再現率
  "f1": 0.686, // F1スコア
  "optimal_threshold": 0.1, // 最適閾値
  "sample_count": 260, // 評価サンプル数
  "positive_count": 160, // 継続者数
  "negative_count": 100, // 非継続者数
  "continuation_rate": 0.615 // 継続率
}
```

### 重要な指標

| 指標      | 意味                           | 目標値       |
| --------- | ------------------------------ | ------------ |
| AUC-ROC   | 全体的な判別能力               | > 0.7        |
| AUC-PR    | 不均衡データでの判別能力       | > 0.8        |
| Precision | 継続予測の正確さ               | > 0.7        |
| Recall    | 実際の継続者を捕捉できる割合   | > 0.6        |
| F1        | Precision と Recall のバランス | > 0.65       |
| 継続率    | データのバランス               | 30-70%が理想 |

---

## 🔍 トラブルシューティング

### エラー: `FileNotFoundError: data/review_requests_openstack_multi_5y_detail.csv`

```bash
# データファイルの存在確認
ls -lh data/review_requests_openstack_multi_5y_detail.csv

# データファイルがない場合は、他のデータファイルを使用
# run_cross_evaluation_simple.sh の REVIEWS_FILE を変更
```

### エラー: メモリ不足

```bash
# エポック数を減らす
# run_cross_evaluation_simple.sh の EPOCHS=20 を EPOCHS=10 に変更
```

### プロセスが停止している

```bash
# プロセス確認
ps aux | grep train_irl_per_timestep

# 停止している場合は再実行
pkill -f train_irl_per_timestep
bash scripts/training/irl/run_cross_evaluation_simple.sh > /tmp/cross_eval.log 2>&1 &
```

---

## 🎯 期待される結果

### 基準値（0-3m モデル、エポック 5）

```
AUC-ROC: 0.740
AUC-PR: 0.849
Precision: 0.825
Recall: 0.588
F1: 0.686
```

### エポック 20 での期待値

```
AUC-ROC: 0.75-0.80
AUC-PR: 0.85-0.90
F1: 0.70-0.75
```

### 訓練ラベル別の予想

- **0-1m**: より厳しい条件 → Recall 低め、Precision 高め
- **0-3m**: バランス良好
- **0-6m**: 継続率上昇 → Recall 高め
- **0-9m**: さらに継続率上昇
- **0-12m**: 最も継続率が高い → Recall 最高

---

## 📝 次のステップ

### 結果が良好な場合

1. **将来窓の最適化**: 最も性能の良いラベル期間を特定
2. **本格的なクロス評価**: 訓練ラベルと評価期間を分離
   - 例: 0-3m で訓練 → 3-6m, 6-9m で評価
3. **ハイパーパラメータチューニング**

### 結果が不十分な場合

1. **エポック数をさらに増やす**: 20 → 30-50
2. **データ期間を延長**: 2 年 → 3-5 年
3. **特徴量エンジニアリング**: プロジェクト固有特徴を追加

---

## 📚 関連ドキュメント

- [全シーケンス月次集約ラベル実験結果](./全シーケンス月次集約ラベル実験結果.md)
- [IRL 設計書](./IRL_redesign_with_training_period_labels.md)
- [クロス窓評価実験設計](./クロス窓評価実験設計.md)

---

## ✅ チェックリスト

実行前に確認：

- [ ] データファイルが存在する
- [ ] 十分なディスク容量がある（約 5GB）
- [ ] バックグラウンド実行している
- [ ] ログファイルのパスを確認した

実行中：

- [ ] 定期的に進捗を確認
- [ ] エラーが出ていないかログをチェック
- [ ] メモリ使用量を監視

実行後：

- [ ] 全 5 モデルが完了
- [ ] metrics.json が全て生成されている
- [ ] summary.csv で結果を確認
- [ ] 最高性能のモデルを特定
