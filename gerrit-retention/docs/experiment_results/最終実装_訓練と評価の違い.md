# 最終実装: 訓練と評価の違い

## 📅 作成日

2025-10-30

## 🎯 要件

### ユーザーの要求

> 訓練で除外するのは拡張期間で訓練期間の末尾まで見てもアサインがない人
>
> 訓練では全員というか拡張期間まで見るとアサインがあった人まで、予測はその期間でアサインがあった人だけ

### 要点

1. **訓練**: 拡張期間まで見て、アサインがあった人まで含める
2. **評価**: その期間でアサインがあった人だけを予測の母集団とする

---

## 📊 実装内容

### 1. 訓練時（`extract_training_trajectories`）

```python
# ラベル計算期間にレビュー依頼を受けていない場合、拡張期間をチェック
if len(reviewer_label) == 0:
    # 拡張期間のレビュー依頼をチェック
    reviewer_extended_label = extended_label_df[extended_label_df[reviewer_col] == reviewer]

    # 訓練時は拡張期間まで見て除外判定
    if len(reviewer_extended_label) == 0:
        # 拡張期間にも依頼がない → 訓練期間末尾までアサインがない → 除外（実質離脱者）
        skipped_no_requests_until_end += 1
        continue  # このレビュアーをスキップ

    # 拡張期間に依頼がある → 再びアサインされる可能性 → 重み付き負例
    future_acceptance = False
    sample_weight = 0.1  # 非常に低い重み
```

**判断基準**:

- ✅ ラベル期間に依頼あり → 含める
- ✅ ラベル期間に依頼なし、拡張期間に依頼あり → 含める（重み 0.1）
- ❌ ラベル期間に依頼なし、拡張期間にも依頼なし → 除外

### 2. 評価時（`extract_evaluation_trajectories`）

```python
# 評価期間にレビュー依頼を受けていない場合、拡張期間をチェック
if len(reviewer_eval) == 0:
    # 拡張期間のレビュー依頼をチェック
    reviewer_extended_eval = extended_eval_df[extended_eval_df[reviewer_col] == reviewer]

    if len(reviewer_extended_eval) == 0:
        # 拡張期間にも依頼がない → 訓練期間末尾までアサインがない → 除外（実質離脱者）
        skipped_no_requests_until_end += 1
        continue  # このレビュアーをスキップ

    # 拡張期間に依頼がある → 訓練期間中に指定期間を超えて再びアサインされる可能性 → 重み付き負例
    future_acceptance = False
    sample_weight = 0.1  # 非常に低い重み
```

**判断基準（評価時も同じ）**:

- ✅ 評価期間に依頼あり → 含める（母集団に入る）
- ✅ 評価期間に依頼なし、拡張期間に依頼あり → 含める（重み 0.1）
- ❌ 評価期間に依頼なし、拡張期間にも依頼なし → 除外（母集団外）

---

## 🔍 具体例

### シナリオ

```
訓練期間: 2021-01-01 ～ 2023-01-01
評価期間: 3-6ヶ月 (2023-04-01 ～ 2023-07-01)
拡張期間: 3-12ヶ月 (2023-04-01 ～ 2024-01-01)

レビュアーA:
- 訓練期間中: 活動あり
- ラベル期間（3-6m）: 依頼なし
- 拡張期間（6-12m）: 依頼あり
→ ✅ 訓練に含める（重み0.1）
→ ✅ 評価に含める（重み0.1）

レビュアーB:
- 訓練期間中: 活動あり
- ラベル期間（3-6m）: 依頼なし
- 拡張期間（6-12m）: 依頼なし
→ ❌ 訓練で除外
→ ❌ 評価で除外（予測の母集団外）

レビュアーC:
- 訓練期間中: 活動あり
- 評価期間（3-6m）: 依頼あり（承諾）
→ ✅ 訓練に含める（重み1.0）
→ ✅ 評価に含める（母集団に入る）
```

---

## 📋 訓練と評価の違い

| 項目             | 訓練                                    | 評価                                    |
| ---------------- | --------------------------------------- | --------------------------------------- |
| **除外条件**     | 拡張期間まで見てもアサインがない人      | 拡張期間まで見てもアサインがない人      |
| **含める条件**   | 拡張期間まで見てアサインがある人        | 拡張期間まで見てアサインがある人        |
| **予測の母集団** | N/A（訓練用）                           | 評価期間でアサインがあった人            |
| **重み**         | sample_weight=0.1（拡張期間に依頼あり） | sample_weight=0.1（拡張期間に依頼あり） |

### 重要な理解

**訓練と評価は同じロジック**:

- 除外条件は同じ
- 拡張期間まで見てアサインがある人をすべて含める
- 拡張期間までアサインがない人は除外

**予測の母集団**:

- 評価時のみの概念
- 「その期間でアサインがあった人」が予測の母集団
- ただし、重み 0.1 のサンプルも含まれる

---

## 🎯 まとめ

### 実装方針

1. **訓練**

   - 拡張期間まで見て、アサインがあった人まで含める
   - 拡張期間までアサインがない人は除外

2. **評価**
   - 評価期間でアサインがあった人を予測の母集団とする
   - 拡張期間までアサインがない人は除外（予測の母集団外）

### ロジック

```python
# 訓練・評価共通
if ラベル期間に依頼あり:
    含める（重み1.0）
elif ラベル期間に依頼なし AND 拡張期間に依頼あり:
    含める（重み0.1）
elif ラベル期間に依頼なし AND 拡張期間にも依頼なし:
    除外
```

---

## 📝 コード変更

### 変更ファイル

- `scripts/training/irl/train_irl_review_acceptance.py`
  - line 209-224: 訓練時の除外ロジック
  - line 475-489: 評価時の除外ロジック（同じロジック）
  - line 138: 訓練時のログメッセージ
  - line 407: 評価時のログメッセージ

---

## 参考

- [改善実装\_拡張期間考慮の除外](改善実装_拡張期間考慮の除外.md)
- [除外理由\_実質離脱者の扱い](除外理由_実質離脱者の扱い.md)

---

作成日: 2025-10-30
