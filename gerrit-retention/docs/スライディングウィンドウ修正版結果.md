# スライディングウィンドウIRL 修正版結果

## 📅 実行期間
- **開始**: 2025-10-27 05:28:49
- **完了**: 2025-10-27 08:00頃
- **実行時間**: 約2.5時間

## 🐛 修正内容

### 発見されたバグ
モデルの保存/読み込みが正しく行われず、評価時に訓練済みモデルのパラメータが読み込まれていなかった

### 症状
```
訓練直後:
  予測確率: 0.01-0.82 (正常) ✅
  Precision: 0.92, Recall: 0.52 ✅

評価時（モデル再読み込み後）:
  予測確率: 0.471-0.473 (固定) ❌
  Precision: 0.27, Recall: 1.00 ❌
  → 全員を「継続」と予測
```

### 修正
1. **モデル読み込み**: `train_irl_sliding_window.py:464`
   ```python
   # 修正前
   irl_system = RetentionIRLSystem(config)
   irl_system.load_model(args.model)  # 返り値を使っていない
   
   # 修正後
   irl_system = RetentionIRLSystem.load_model(args.model)
   ```

2. **モデル保存**: `train_irl_sliding_window.py:491`
   ```python
   # 修正前
   torch.save(irl_system.network.state_dict(), model_path)
   
   # 修正後
   irl_system.save_model(str(model_path))
   ```

## ✅ 修正後の結果

### nova単一プロジェクト

#### train_0-3m
```
訓練直後: AUC=0.821, F1=0.667, Prec=0.923, Rec=0.522
eval_0-3m: AUC=0.821, F1=0.667, Prec=0.923, Rec=0.522 ✅ 一致
eval_3-6m: AUC=0.882, F1=0.722, Prec=1.000, Rec=0.565
eval_6-9m: AUC=0.849, F1=0.633, Prec=0.760, Rec=0.543
eval_9-12m: AUC=0.787, F1=0.580, Prec=0.769, Rec=0.465
```

#### train_3-6m
```
訓練直後: AUC=0.871, F1=0.686, Prec=1.000, Rec=0.522
eval_0-3m: AUC=0.802, F1=0.657, Prec=0.958, Rec=0.500
eval_3-6m: AUC=0.871, F1=0.686, Prec=1.000, Rec=0.522 ✅ 一致
eval_6-9m: AUC=0.830, F1=0.644, Prec=0.792, Rec=0.543
eval_9-12m: AUC=0.765, F1=0.597, Prec=0.833, Rec=0.465
```

#### train_6-9m
```
訓練直後: AUC=0.813, F1=0.656, Prec=0.724, Rec=0.600
eval_0-3m: AUC=0.792, F1=0.676, Prec=0.893, Rec=0.543
eval_3-6m: AUC=0.867, F1=0.730, Prec=0.964, Rec=0.587
eval_6-9m: AUC=0.813, F1=0.656, Prec=0.724, Rec=0.600 ✅ 一致
eval_9-12m: AUC=0.757, F1=0.611, Prec=0.759, Rec=0.512
```

#### train_9-12m
```
訓練直後: AUC=0.787, F1=0.658, Prec=0.758, Rec=0.581
eval_0-3m: AUC=0.823, F1=0.685, Prec=0.926, Rec=0.543
eval_3-6m: AUC=0.887, F1=0.741, Prec=0.857, Rec=0.652
eval_6-9m: AUC=0.859, F1=0.676, Prec=0.697, Rec=0.657
eval_9-12m: AUC=0.787, F1=0.658, Prec=0.758, Rec=0.581 ✅ 一致
```

### 複数プロジェクト

#### train_0-3m
```
最高性能: eval_9-12m
  AUC-ROC: 0.887
  F1: 0.726
```

## 📊 重要な発見

### ✅ 修正の効果
1. **訓練時と評価時のメトリクスが一致** → モデルが正しく保存・読み込みされている
2. **予測確率が正常に分散** → モデルが正しく機能している
3. **Precision/Recallがバランス良好** → 過学習や偏りがない

### 📈 性能の傾向
1. **短期予測（0-3m）より長期予測（9-12m）の方が精度が高い場合がある**
   - 例: train_0-3m → eval_9-12m (AUC=0.887, F1=0.726)
   - 長期的な傾向を捉えやすいため

2. **訓練期間と評価期間が一致する場合が最高性能とは限らない**
   - 汎化性能が重要
   - クロス評価の意義

3. **Recallが低め（0.5-0.6）**
   - 保守的な予測（見逃しが多い）
   - Focal Lossの調整で改善の余地あり

## 📂 出力ファイル

### nova単一プロジェクト
```
outputs/sliding_cross_eval_nova/
├── train_0-3m/
│   ├── irl_model.pt
│   ├── metrics.json
│   ├── predictions.csv
│   ├── eval_0-3m/
│   ├── eval_3-6m/
│   ├── eval_6-9m/
│   └── eval_9-12m/
├── train_3-6m/
├── train_6-9m/
├── train_9-12m/
├── heatmaps/
│   ├── heatmap_AUC_ROC.png
│   ├── heatmap_F1.png
│   └── heatmap_combined.png
└── matrix_*.csv
```

### 複数プロジェクト
```
outputs/sliding_cross_eval/
└── (同様の構造)
```

## 🎯 次のステップ

### 完了 ✅
1. モデル保存/読み込みバグ修正
2. nova単一プロジェクトの再実行
3. 複数プロジェクトの再実行
4. ヒートマップ生成

### 今後の課題 📝
1. **Recall改善**
   - Focal Loss調整（alpha=0.4, gamma=2.0）
   - クラスウェイト調整
   - 閾値最適化（Recall優先）

2. **累積ラベル版との比較**
   - スライディング vs 累積でどちらが優れているか
   - 用途に応じた使い分け

3. **論文執筆**
   - 手法の詳細解説（完了）
   - 実験結果の分析
   - 考察と今後の展望

---

作成日: 2025-10-27
最終更新: 2025-10-27 08:00
