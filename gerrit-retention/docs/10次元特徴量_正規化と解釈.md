# 10 次元特徴量の正規化方法と解釈

## 📊 概要

**最終モデル**: 10 次元状態特徴量 + 4 次元行動特徴量

- **訓練設定**: LR 0.00005, Epoch 20, Seed 777, Dropout 0.3, Dynamic Focal Loss
- **性能**: AUC-PR 0.699-0.836（平均 0.752）、全モデル正常動作
- **改善**: 8 次元版から平均+40.8%向上

---

## 1. 状態特徴量（10 次元）

### 1.1 経験日数 (experience_days)

**定義**: プロジェクトに初めて参加してから現在までの経過日数

**正規化方法**:

```python
normalized_value = min(experience_days / 730.0, 1.0)  # 2年でキャップ
```

- **範囲**: 0.0 ～ 1.0
- **上限**: 730 日（2 年）で 1.0 に到達
- **根拠**: 2 年以上の経験者は同等のスキルレベルとみなす

**特徴量重要度**: **+0.000390**（中立～やや正）

**解釈**:

- 経験が長いほど **わずかに受諾率が高い**
- ただし影響は非常に小さい（最下位級）
- 経験年数よりも **最近の活動パターン** が重要

---

### 1.2 総コミット数 (total_changes)

**定義**: これまでに作成したコミット（変更）の総数

**正規化方法**:

```python
normalized_value = min(total_changes / 500.0, 1.0)  # 500件でキャップ
```

- **範囲**: 0.0 ～ 1.0
- **上限**: 500 件で 1.0 に到達
- **根拠**: 500 件以上のコミット経験者は十分に活発

**特徴量重要度**: **+0.003307**（正の影響）🥉

**解釈**:

- コミット活動が活発 → **プロジェクト貢献意欲が高い**
- レビュー依頼を受諾しやすい
- 「自分もコード書いている」という相互貢献の意識

---

### 1.3 総レビュー数 (total_reviews)

**定義**: これまでに実施したレビューの総数

**正規化方法**:

```python
normalized_value = min(total_reviews / 500.0, 1.0)  # 500件でキャップ
```

- **範囲**: 0.0 ～ 1.0
- **上限**: 500 件で 1.0 に到達
- **根拠**: 500 件以上のレビュー経験者は十分に熟練

**特徴量重要度**: **+0.005479**（最強の状態特徴量）🥇

**解釈**:

- レビュー経験が豊富 → **受諾率が最も高い**
- レビュー活動への習慣化・コミットメント
- 「レビュー専門家」としてのアイデンティティ

---

### 1.4 最近の活動頻度 (recent_activity_frequency)

**定義**: 直近 30 日間の 1 日あたりの平均活動回数

**正規化方法**:

```python
recent_activities = [活動履歴で直近30日の活動]
normalized_value = min(len(recent_activities) / 30.0, 1.0)
```

- **範囲**: 0.0 ～ 1.0（既に正規化済み）
- **計算**: 直近 30 日の活動数 ÷ 30 日
- **上限**: 1.0（毎日 1 回以上活動）

**特徴量重要度**: **-0.000437**（やや負）

**解釈**:

- **最近活発すぎる → わずかに拒否しやすい**
- 過負荷の兆候を示唆
- ただし影響は非常に小さい

---

### 1.5 平均活動間隔 (avg_activity_gap)

**定義**: 活動と活動の間隔の平均日数

**正規化方法**:

```python
activity_gaps = [活動間の日数リスト]
avg_gap = mean(activity_gaps) if activity_gaps else 30.0
normalized_value = min(avg_gap / 60.0, 1.0)  # 60日でキャップ
```

- **範囲**: 0.0 ～ 1.0
- **上限**: 60 日で 1.0
- **意味**: 値が大きい = 活動間隔が長い = 不規則

**特徴量重要度**: **-0.001195**（負の影響）

**解釈**:

- 活動間隔が長い（不規則） → **拒否しやすい**
- 規則的な活動パターンが継続の鍵
- プロジェクトへのコミットメント低下の指標

---

### 1.6 活動トレンド (activity_trend)

**定義**: 最近の活動量が増加・安定・減少のいずれか

**正規化方法**:

```python
trend_encoding = {
    'increasing': 1.0,   # 増加傾向
    'stable': 0.5,       # 安定
    'decreasing': 0.0,   # 減少傾向
    'unknown': 0.25      # 不明
}
normalized_value = trend_encoding.get(activity_trend, 0.25)
```

- **範囲**: 0.0, 0.25, 0.5, 1.0（離散値）
- **計算**: 過去 60 日 vs 60-120 日の活動量比較

**特徴量重要度**: **-0.001962**（負の影響）

**解釈**:

- **増加傾向でも負の影響！** （意外な結果）
- → **急激な活動増加 = 過負荷の兆候**
- 持続可能な活動レベルが重要

---

### 1.7 協力スコア (collaboration_score)

**定義**: 全活動のうち協力的な活動（レビュー・マージ等）の割合

**正規化方法**:

```python
collaboration_activities = ['review', 'merge', 'collaboration', 'mentoring']
collaboration_count = sum(1 for activity if activity.type in collaboration_activities)
normalized_value = min(collaboration_count / total_activities, 1.0)
```

- **範囲**: 0.0 ～ 1.0（既に正規化済み）
- **計算**: 協力活動数 ÷ 総活動数

**特徴量重要度**: **+0.004301**（強い正の影響）🥈

**解釈**:

- 協力的な開発者 → **受諾率が高い**
- チーム志向・相互支援の文化
- プロジェクトへの社会的コミットメント

---

### 1.8 コード品質スコア (code_quality_score)

**定義**: 全活動のうち品質向上活動（テスト・ドキュメント等）の割合

**正規化方法**:

```python
quality_indicators = ['test', 'documentation', 'refactor', 'fix']
quality_count = sum(1 for activity if any(indicator in activity.message))
normalized_value = min(quality_count / total_activities + 0.3, 1.0)
```

- **範囲**: 0.3 ～ 1.0
- **ベースライン**: 0.3（最低品質スコア）
- **計算**: 品質活動数 ÷ 総活動数 + 0.3

**特徴量重要度**: **-0.001212**（負の影響）

**解釈**:

- 品質重視 → **わずかに拒否しやすい**
- 高品質を求めるがゆえに慎重になる
- またはレビュー負荷が高くなる傾向

---

### 1.9 最近の受諾率 (recent_acceptance_rate) ✨ NEW

**定義**: 直近 30 日のレビュー依頼のうち受諾した割合

**正規化方法**:

```python
cutoff_date = context_date - timedelta(days=30)
recent_activities = [活動履歴で直近30日のレビュー依頼]

review_requests = len(recent_activities)
accepted_reviews = sum(1 for activity if activity.accepted)

if review_requests == 0:
    normalized_value = 0.5  # データなし → 中立
else:
    normalized_value = accepted_reviews / review_requests  # 0.0～1.0
```

- **範囲**: 0.0 ～ 1.0
- **デフォルト**: 0.5（依頼がない場合は中立）
- **計算**: 直近 30 日の受諾数 ÷ 直近 30 日の依頼数

**特徴量重要度**: **-0.002781**（負の影響 - 最も負）⚠️

**解釈**:

- **最近受諾していても、将来は拒否しやすい！**
- → **燃え尽き現象の検出に成功**している可能性
- 「最近頑張りすぎた → 次は休みたい」パターン
- 過去の行動と異なる将来の行動を予測

---

### 1.10 レビュー負荷 (review_load) ✨ NEW

**定義**: 直近 30 日のレビュー依頼数 ÷ 平均レビュー依頼数

**正規化方法**:

```python
cutoff_date = context_date - timedelta(days=30)
recent_activities = [活動履歴で直近30日のレビュー依頼]
recent_requests = len(recent_activities)

# 全期間の平均依頼数を計算
total_requests = len([全履歴のレビュー依頼])
period_days = (max_timestamp - min_timestamp).days + 1
avg_requests_per_period = total_requests / max(period_days / 30.0, 1.0)

# 負荷比率を正規化
load_ratio = recent_requests / avg_requests_per_period
normalized_value = min(load_ratio / 2.0, 1.0)  # 2倍の負荷を1.0にマッピング
```

- **範囲**: 0.0 ～ 1.0
- **基準**: 平均負荷 = 0.5、2 倍の負荷 = 1.0
- **計算**: (直近 30 日の依頼数 / 平均依頼数) ÷ 2

**特徴量重要度**: **-0.000923**（負の影響）

**解釈**:

- 負荷が高い → **拒否しやすい**
- 過負荷状態の検出に成功
- キャパシティ管理の重要性

---

## 2. 行動特徴量（4 次元）

### 2.1 強度 (intensity)

**定義**: レビュー活動の強度（変更行数等から算出）

**正規化方法**:

```python
lines_added = activity.lines_added or 0
lines_deleted = activity.lines_deleted or 0
total_lines = lines_added + lines_deleted

normalized_value = min(intensity, 1.0)  # 既に0-1と仮定
```

- **範囲**: 0.0 ～ 1.0（既に正規化済みと仮定）
- **計算**: 変更行数等に基づく

**特徴量重要度**: **+0.001173**（やや正）

**解釈**:

- レビュー活動が活発 → わずかに受諾しやすい
- ただし影響は小さい

---

### 2.2 品質 (quality/message_quality)

**定義**: レビューコメントの質や重要度

**正規化方法**:

```python
normalized_value = min(quality, 1.0)  # 既に0-1と仮定
```

- **範囲**: 0.0 ～ 1.0（既に正規化済みと仮定）
- **計算**: コメントの詳細度・建設性等

**特徴量重要度**: **+0.009700**（最強特徴量！）🥇🥇

**解釈**:

- **レビューの質が高い → 受諾率が最も高い**
- 質の高いレビュー文化への貢献意識
- プロフェッショナルとしての誇り

---

### 2.3 協力度 (collaboration)

**定義**: レビュー活動における協力的な態度

**正規化方法**:

```python
normalized_value = min(collaboration, 1.0)  # 既に0-1と仮定
```

- **範囲**: 0.0 ～ 1.0（既に正規化済みと仮定）
- **計算**: 協力的なコメント・建設的な提案等

**特徴量重要度**: **+0.000755**（やや正）

**解釈**:

- 協力的な態度 → わずかに受諾しやすい
- チーム文化への貢献

---

### 2.4 応答速度 (response_speed)

**定義**: レビュー依頼を受けてから応答するまでの速さ

**正規化方法**:

```python
# response_time（日数）を「素早さ」に変換
response_speed = 1.0 / (1.0 + response_time / 3.0)
normalized_value = min(response_speed, 1.0)
```

- **範囲**: 0.0 ～ 1.0
- **変換**: 即日応答 = 1.0、3 日後 = 0.5、10 日以上 = 0 に近い
- **根拠**: 素早い応答 = 高いエンゲージメント

**特徴量重要度**: **+0.006493**（強い正の影響）🥈

**解釈**:

- **素早く応答 → 受諾率が高い**
- 積極的な姿勢・プロジェクトへのコミットメント
- タイムリーなレビューの重要性

---

## 3. 特徴量重要度ランキング

### 3.1 全特徴量（14 次元）

| 順位   | 特徴量           | カテゴリ | 重要度        | 解釈                               |
| ------ | ---------------- | -------- | ------------- | ---------------------------------- |
| **1**  | **品質**         | 行動     | **+0.009700** | 質の高いレビュー → 強い受諾意欲 🥇 |
| **2**  | **応答速度**     | 行動     | **+0.006493** | 素早い応答 → 高いコミットメント 🥈 |
| **3**  | **総レビュー数** | 状態     | **+0.005479** | 豊富な経験 → 習慣化・専門性 🥉     |
| 4      | 協力スコア       | 状態     | +0.004301     | 協力的 → チーム貢献意識            |
| 5      | 総コミット数     | 状態     | +0.003307     | 活発 → 相互貢献意識                |
| 6      | 強度             | 行動     | +0.001173     | 活発な活動 → やや正                |
| 7      | 協力度           | 行動     | +0.000755     | 協力的態度 → やや正                |
| 8      | 経験日数         | 状態     | +0.000390     | 長い経験 → やや正                  |
| 9      | 最近の活動頻度   | 状態     | -0.000437     | 過活動 → やや負                    |
| 10     | レビュー負荷     | 状態     | -0.000923     | 高負荷 → 拒否傾向 ⚠️               |
| 11     | 平均活動間隔     | 状態     | -0.001195     | 不規則 → 低コミットメント          |
| 12     | コード品質スコア | 状態     | -0.001212     | 高品質重視 → 慎重                  |
| 13     | 活動トレンド     | 状態     | -0.001962     | 急増加 → 過負荷兆候                |
| **14** | **最近の受諾率** | 状態     | **-0.002781** | 最近受諾 → 燃え尽き ⚠️             |

### 3.2 新規追加特徴量（2 つ）の効果

| 特徴量           | 重要度        | 順位            | 効果                      |
| ---------------- | ------------- | --------------- | ------------------------- |
| **最近の受諾率** | **-0.002781** | 14 位（最も負） | **燃え尽き検出に成功** ✅ |
| **レビュー負荷** | **-0.000923** | 10 位（負）     | **過負荷検出に成功** ✅   |

**総合効果**: この 2 特徴の追加により、8 次元版から**平均+40.8%**の性能向上を達成！

---

## 4. 重要な発見

### 4.1 燃え尽き現象の検出

**「最近の受諾率」が負の重要度を持つ理由**:

1. **逆説的パターン**: 最近受諾していても、将来は拒否する
2. **燃え尽きの兆候**: 「頑張りすぎた → 次は休みたい」
3. **行動変化の予測**: 過去と異なる将来の行動を学習

→ モデルが単純な「過去の受諾率 = 将来の受諾率」ではなく、**より複雑な行動パターン**を学習している証拠

### 4.2 質の重要性

**「品質」が最強特徴量（+0.009700）の理由**:

1. **プロフェッショナリズム**: 質の高いレビューをする人は継続する
2. **レビュー文化**: 質重視の文化への貢献意識
3. **内発的動機**: 質の高い仕事への誇り

### 4.3 過負荷の検出

**複数の負荷指標が負の影響**:

- レビュー負荷: -0.000923
- 最近の活動頻度: -0.000437
- 活動トレンド（増加）: -0.001962

→ **持続可能な活動レベル**が継続の鍵

---

## 5. 実装詳細

### 5.1 コード実装

**正規化の実装場所**: `src/gerrit_retention/rl_prediction/retention_irl_system.py`

```python
def state_to_tensor(self, state: DeveloperState) -> torch.Tensor:
    """状態をテンソルに変換（10次元版 - 全特徴量を0-1に正規化）"""

    trend_encoding = {
        'increasing': 1.0,
        'stable': 0.5,
        'decreasing': 0.0,
        'unknown': 0.25
    }

    features = [
        min(state.experience_days / 730.0, 1.0),
        min(state.total_changes / 500.0, 1.0),
        min(state.total_reviews / 500.0, 1.0),
        min(state.recent_activity_frequency, 1.0),
        min(state.avg_activity_gap / 60.0, 1.0),
        trend_encoding.get(state.activity_trend, 0.25),
        min(state.collaboration_score, 1.0),
        min(state.code_quality_score, 1.0),
        min(state.recent_acceptance_rate, 1.0),
        min(state.review_load, 1.0)
    ]

    return torch.tensor(features, dtype=torch.float32, device=self.device)
```

### 5.2 正規化の利点

1. **スケール統一**: 全特徴量が 0-1 の範囲に
2. **公平な比較**: 勾配ベースの重要度が正しく計算可能
3. **学習安定性**: ニューラルネットワークの収束が安定
4. **解釈容易性**: 値の意味が直感的

---

## 6. まとめ

### 6.1 最終モデル仕様

- **状態特徴量**: 10 次元（全て 0-1 に正規化）
- **行動特徴量**: 4 次元（全て 0-1 に正規化）
- **総次元数**: 14 次元
- **性能**: AUC-PR 0.699-0.836（平均 0.752）
- **安定性**: 全モデル正常動作（Recall=1.0 崩壊なし）

### 6.2 主要な成果

1. **8 次元版から+40.8%の性能向上**
2. **燃え尽き検出に成功**（最近の受諾率の負の重要度）
3. **質の重要性を定量化**（最強特徴量）
4. **過負荷検出に成功**（レビュー負荷の負の重要度）

### 6.3 実用的示唆

1. **質の高いレビュー文化の醸成**が継続の鍵
2. **素早い応答**がエンゲージメントの指標
3. **過負荷の早期検出**で燃え尽きを防止
4. **持続可能な活動レベル**の重要性
