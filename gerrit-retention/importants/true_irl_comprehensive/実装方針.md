# True IRL 包括的評価 実装方針

**作成日**: 2025-10-19
**スクリプト**: `scripts/training/irl/evaluate_true_irl_comprehensive.py`

## 目的

**True IRL システム**（LSTM搭載のEnhancedRetentionIRLSystem）の包括的評価を実施し、以下を明らかにする:

1. 時系列IRLによる開発者継続予測の精度
2. 最適な学習期間と予測期間の組み合わせ
3. 単一プロジェクト学習と複数プロジェクト学習の性能差

## 重要な設計変更: 3つの期間の関係

### 従来の問題点

従来のスクリプトでは、**IRL学習期間**が明確に定義されておらず、利用可能な全データを使用していました。これでは学習期間の長さによる公平な比較ができません。

### 新しい設計: 3つの期間を明確に定義

```
タイムライン:

[IRL学習期間] [学習期間] | [待機期間] | [判定期間]
                    スナップショット日  判定開始日
                         ↑              ↑
                    ここを基準に分割   この時点以降の活動で判定
```

#### 1. IRL学習期間 (IRL Training Period)

**定義**: IRLモデルを学習するために使用するデータの期間

**重要**: この期間の長さは**学習期間と同じ**に設定

**理由**:
- 時間的一貫性を保つ
- 学習期間ごとに公平な比較を可能にする
- 実際の運用を想定（限られた履歴データしかない）

**計算**:
```
IRL学習期間の開始日 = スナップショット日 - 学習期間
IRL学習期間の終了日 = スナップショット日
```

#### 2. 学習期間 (Learning Period)

**定義**: レビュアーの行動軌跡を観測する期間（特徴量抽出に使用）

**別名**: 履歴期間、観測期間

**用途**:
- レビュアーごとの軌跡（trajectory）を構築
- 状態特徴量（state features）と行動特徴量（action features）を抽出
- LSTMへの入力シーケンスを作成

**計算**:
```
学習期間の開始日 = スナップショット日 - 学習期間
学習期間の終了日 = スナップショット日
```

**注意**: 学習期間とIRL学習期間は**同じ期間**を指す

#### 3. 予測期間 (Prediction Period / Waiting Period)

**定義**: 継続判定を開始するまでの待機期間

**重要な変更**: 予測期間は「判定までの待ち時間」を意味し、**予測期間後（n ヶ月後以降）**に活動があるかどうかを判定

**用途**:
- ラベル付け（継続=1, 離脱=0）
- 「n ヶ月後も残っているか」を予測

**計算**:
```
判定開始日 = スナップショット日 + 予測期間
継続判定 = 判定開始日以降に活動があれば継続 (1)、なければ離脱 (0)
```

**実用的な意味**:
- 3ヶ月予測 = 「3ヶ月後以降も活動しているか」
- 12ヶ月予測 = 「12ヶ月後以降も活動しているか」

### 具体例: 3ヶ月学習 × 6ヶ月予測

```
スナップショット日: 2020-01-01

タイムライン:
2019-10-01        2020-01-01        2020-07-01        将来...
    |                 |                 |                |
    |<--- 3ヶ月 ----->|<----- 6ヶ月 ---->|                |
    |                 |      (待機)      |   (判定期間)   |
IRL学習開始      スナップショット    判定開始日
学習期間開始                        この時点以降の活動で判定

使用するデータ:
- IRL学習: 2019-10-01 ~ 2020-01-01 (3ヶ月分)
- 軌跡構築: 2019-10-01 ~ 2020-01-01 (3ヶ月分) ← IRL学習期間と同じ
- ラベル付け: 2020-07-01以降に活動があるか判定
  - 2020-07-01以降に活動あり → 継続 (1)
  - 2020-07-01以降に活動なし → 離脱 (0)

意味: 「6ヶ月後も残っているか？」を予測
```

### 具体例: 12ヶ月学習 × 3ヶ月予測

```
スナップショット日: 2020-01-01

タイムライン:
2019-01-01                    2020-01-01    2020-04-01        将来...
    |                             |             |                |
    |<--------- 12ヶ月 ---------->|<-- 3ヶ月 -->|                |
    |                             |   (待機)    |   (判定期間)   |
IRL学習開始                  スナップショット  判定開始日
学習期間開始                                  この時点以降の活動で判定

使用するデータ:
- IRL学習: 2019-01-01 ~ 2020-01-01 (12ヶ月分)
- 軌跡構築: 2019-01-01 ~ 2020-01-01 (12ヶ月分) ← IRL学習期間と同じ
- ラベル付け: 2020-04-01以降に活動があるか判定
  - 2020-04-01以降に活動あり → 継続 (1)
  - 2020-04-01以降に活動なし → 離脱 (0)

意味: 「3ヶ月後も残っているか？」を予測
```

### 期間設定の利点

| 設計原則 | 説明 |
|---------|------|
| **時間的一貫性** | モデルが予測する期間と同じ長さのデータから学習 |
| **公平な比較** | 異なる学習期間設定で比例したデータ量を使用 |
| **現実的** | 実際の運用では限られた履歴データしか利用できない状況を再現 |
| **データリーク防止** | 学習データと評価データの明確な分離 |

## 評価設定

### データセット

**ファイル**: `data/review_requests_openstack_multi_5y_detail.csv`

**統計情報**:
- サイズ: 78.75 MB
- レビュー総数: 137,632件
- 期間: 2012-06-20 ～ 2025-09-27（13.3年間）
- レビュアー数: 1,379人
- プロジェクト数: 5個

**プロジェクト別内訳**:
1. openstack/cinder: 71,604件（52.0%）
2. openstack/nova: 36,127件（26.2%）
3. openstack/neutron: 16,915件（12.3%）
4. openstack/glance: 11,203件（8.1%）
5. openstack/keystone: 1,783件（1.3%）

### パラメータ

| パラメータ | 値 | 理由 |
|-----------|---|------|
| **スナップショット日** | 2020-01-01 | 前後に十分なデータがある（前7.5年、後5年） |
| **学習期間** | 3, 6, 9, 12ヶ月 | 四半期・半期の標準的な区切り |
| **予測期間** | 3, 6, 9, 12ヶ月 | 学習期間と対称的に評価 |
| **シーケンス長** | 15 | レビュアー活動の75パーセンタイル |
| **学習エポック数** | 30 | 収束と計算時間のバランス |

### 評価モード

#### 1. 複数プロジェクトモード（Multi-Project）

- **データ**: 5プロジェクト全体を統合
- **学習**: 全プロジェクトのデータでIRLを学習
- **予測**: 全プロジェクトのレビュアーをテスト
- **用途**: 汎用的な継続予測モデル

#### 2. 単一プロジェクトモード（Single-Project）

- **データ**: プロジェクトごとに分離
- **学習**: 各プロジェクトのデータのみでIRLを学習
- **予測**: そのプロジェクトのレビュアーのみテスト
- **用途**: プロジェクト固有の継続パターン分析
- **出力**: 5つの独立した評価（各プロジェクト1つ）

### スライディングウィンドウ

4 × 4 = **16設定** を各モードで実施:

|   | 3ヶ月予測 | 6ヶ月予測 | 9ヶ月予測 | 12ヶ月予測 |
|---|----------|----------|----------|-----------|
| **3ヶ月学習** | ✓ | ✓ | ✓ | ✓ |
| **6ヶ月学習** | ✓ | ✓ | ✓ | ✓ |
| **9ヶ月学習** | ✓ | ✓ | ✓ | ✓ |
| **12ヶ月学習** | ✓ | ✓ | ✓ | ✓ |

**合計評価数**:
- 複数プロジェクト: 16設定
- 単一プロジェクト: 16設定 × 5プロジェクト = 80設定
- **総計**: 96モデル学習

## 軌跡（Trajectory）の構築

### データ構造

各軌跡は1人のレビュアーの学習期間内の活動を表す:

```python
trajectory = {
    "states": np.array([...]),    # 形状: (seq_len, 10)
    "actions": np.array([...]),   # 形状: (seq_len, 5)
    "reviewer": "reviewer@email.com"
}
```

### 特徴量抽出（拡張版）

**状態特徴量（32次元）**:

**基本特徴量（10次元）**:
1. 経験日数
2. 変更総数
3. レビュー総数
4. プロジェクト数
5. 最近の活動頻度
6. 平均活動間隔
7. 活動トレンド
8. コラボレーションスコア
9. コード品質スコア
10. 最終活動からの経過時間

**A1: 活動頻度の多期間比較（5次元）**:
11. 7日間の活動頻度
12. 30日間の活動頻度
13. 90日間の活動頻度
14. 活動加速度（7日 vs 30日）
15. 一貫性スコア

**B1: レビュー負荷指標（6次元）**:
16. 7日間のレビュー負荷
17. 30日間のレビュー負荷
18. 180日間のレビュー負荷
19. レビュー負荷トレンド
20. 過負荷フラグ（1日5件以上）
21. 高負荷フラグ（1日2件以上）

**C1: 相互作用の深さ（4次元）**:
22. 180日間の相互作用回数
23. 相互作用強度（月あたり）
24. プロジェクト固有の相互作用
25. 割り当て履歴

**D1: 専門性の一致度（2次元）**:
26. パス類似度スコア（Jaccard）
27. パス重複スコア（Overlap）

**その他有用指標（5次元）**:
28. 平均レスポンス時間（日）
29. レスポンス率（180日）
30. 在籍日数
31. 平均変更サイズ
32. 平均変更ファイル数

**行動特徴量（9次元）**:

**基本特徴量（5次元）**:
1. 行動タイプ（review=0.8）
2. 強度
3. 品質
4. コラボレーション
5. タイムスタンプからの経過日数

**拡張特徴量（4次元）**:
6. 変更サイズ（追加+削除行数）
7. ファイル数
8. 複雑度（変更サイズ/ファイル数）
9. レスポンス遅延（日）

### シーケンス処理

- **短いシーケンス**（< 15レビュー）: 最初のレビューを繰り返してパディング
- **長いシーケンス**（≥ 15レビュー）: 最新15レビューを使用

**理由**: 最近の行動に焦点を当て、LSTMの固定入力サイズを確保

### ラベル付け戦略

```python
判定開始日 = スナップショット日 + 予測期間

if レビュアーが判定開始日以降に活動あり:
    label = 1  # 継続（n ヶ月後も残っている）
else:
    label = 0  # 離脱（n ヶ月後には活動していない）
```

**重要**:
- 判定開始日**以降**の活動で判定（予測期間内ではない）
- 活動は量に関わらず、1件でもあれば継続とみなす
- 実用的な意味: 「n ヶ月後も残っているか？」を予測

## モデルアーキテクチャ

### EnhancedRetentionIRLSystem（LSTM搭載）

```
入力: 軌跡 [batch, seq_len, state_dim + action_dim]
  ↓
状態エンコーダ（32次元 → 64次元）:
  Linear(32, 128)
  → LayerNorm
  → ReLU
  → Dropout(0.3)
  → Linear(128, 64)
  → LayerNorm
  → ReLU
  ↓
行動エンコーダ（9次元 → 64次元）:
  Linear(9, 128)
  → LayerNorm
  → ReLU
  → Dropout(0.3)
  → Linear(128, 64)
  → LayerNorm
  → ReLU
  ↓
状態+行動を結合（加算） → 64次元
  ↓
LSTM（2層, hidden_size=128, dropout=0.3）
  ↓
2つのヘッドに分岐:
  ├─ 報酬予測器: Linear(128, 64) → ReLU → Linear(64, 1)
  └─ 継続予測器: Linear(128, 64) → ReLU → Linear(64, 1) → Sigmoid
```

### 学習設定

```python
config = {
    "state_dim": 32,            # 拡張状態特徴量
    "action_dim": 9,            # 拡張行動特徴量
    "hidden_dim": 128,
    "learning_rate": 0.001,
    "sequence": True,           # LSTMを有効化
    "seq_len": 15,
    "use_layer_norm": True,     # 強化版
    "dropout_rate": 0.3,        # 正則化
}
```

## 評価指標

### 主要指標

1. **AUC-ROC**（ROC曲線下面積）
   - 範囲: 0.0 ～ 1.0
   - 解釈:
     - 0.9-1.0: 優秀
     - 0.8-0.9: 良好
     - 0.7-0.8: まあまあ
     - 0.5: ランダム
   - 全体的な識別能力を測定

2. **AUC-PR**（Precision-Recall曲線下面積）
   - 範囲: 0.0 ～ 1.0
   - 不均衡データセットでより有益
   - 希少な正例（継続）に対して重要

3. **F1スコア**
   - PrecisionとRecallの調和平均
   - 偽陽性と偽陰性のバランスを取る
   - 閾値: 0.5で二値分類

### 副次指標

4. **Precision**: 真陽性 / (真陽性 + 偽陽性)
5. **Recall**: 真陽性 / (真陽性 + 偽陰性)
6. **混同行列**: TN, FP, FN, TPの件数

## 出力ファイル

### ディレクトリ構造

```
importants/true_irl_comprehensive/
├── data_analysis/                           # データ分析結果（既存）
│   ├── dataset_stats.json
│   ├── project_stats.csv
│   └── ...
├── models/
│   ├── multi_project/
│   │   ├── irl_h3m_t3m.pth
│   │   ├── irl_h3m_t6m.pth
│   │   ├── ...
│   │   └── irl_h12m_t12m.pth              (16モデル)
│   ├── project_openstack_cinder/
│   │   └── ... (16モデル)
│   ├── project_openstack_nova/
│   │   └── ... (16モデル)
│   ├── project_openstack_neutron/
│   │   └── ... (16モデル)
│   ├── project_openstack_glance/
│   │   └── ... (16モデル)
│   └── project_openstack_keystone/
│       └── ... (16モデル)
├── sliding_window_results_multi_project.csv
├── sliding_window_results_project_openstack_cinder.csv
├── sliding_window_results_project_openstack_nova.csv
├── sliding_window_results_project_openstack_neutron.csv
├── sliding_window_results_project_openstack_glance.csv
├── sliding_window_results_project_openstack_keystone.csv
├── heatmaps_multi_project.png
├── heatmaps_project_openstack_cinder.png
├── heatmaps_project_openstack_nova.png
├── heatmaps_project_openstack_neutron.png
├── heatmaps_project_openstack_glance.png
├── heatmaps_project_openstack_keystone.png
├── EVALUATION_PLAN.md                      (英語版計画書)
├── 実装方針.md                              (この日本語ドキュメント)
└── EVALUATION_REPORT.md                    (評価後に生成)
```

### CSVファイル形式

各`sliding_window_results_*.csv`の列:

| 列名 | 説明 |
|------|------|
| learning_months | 学習期間の長さ（月） |
| prediction_months | 予測期間の長さ（月） |
| project | プロジェクト名（複数プロジェクトの場合は"all"） |
| n_trajectories | 使用した軌跡の数 |
| continuation_rate | 継続したレビュアーの割合（%） |
| auc_roc | AUC-ROCスコア |
| auc_pr | AUC-PRスコア |
| f1 | F1スコア |
| precision | Precision |
| recall | Recall |
| tn | 真陰性 |
| fp | 偽陽性 |
| fn | 偽陰性 |
| tp | 真陽性 |
| model_path | 保存されたモデルのパス |

### ヒートマップ可視化

各ヒートマップファイルには5つのサブプロット（2×3グリッド）:
1. AUC-ROC
2. AUC-PR
3. F1スコア
4. Precision
5. Recall

**軸**:
- X軸: 学習期間（3, 6, 9, 12ヶ月）
- Y軸: 予測期間（3, 6, 9, 12ヶ月）

**色**: YlOrRd（黄-橙-赤）、範囲0-1

## 実行コマンド

```bash
uv run python scripts/training/irl/evaluate_true_irl_comprehensive.py \
  --reviews data/review_requests_openstack_multi_5y_detail.csv \
  --snapshot-date 2020-01-01 \
  --learning-months 3 6 9 12 \
  --prediction-months 3 6 9 12 \
  --mode both \
  --epochs 30 \
  --seq-len 15 \
  --output importants/true_irl_comprehensive
```

### 予想実行時間

データサイズとモデルの複雑さに基づく:
- 単一設定: 約2-3分
- 複数プロジェクト（16設定）: 約40-50分
- 単一プロジェクト（1プロジェクト16設定）: 約30-40分
- 全5プロジェクト: 約2.5-3時間
- **合計（96設定）**: 約3-4時間

### メモリ要件

- ピークメモリ: 約4-6 GB RAM
- GPU: 不要（CPU学習で問題なし）
- ディスク容量: 約500 MB（全モデルと出力）

## 期間設定の詳細比較表

### 例1: 3ヶ月学習 × 3ヶ月予測

| 期間の種類 | 開始日 | 終了日 | 期間長 | 用途 |
|-----------|--------|--------|--------|------|
| IRL学習期間 | 2019-10-01 | 2020-01-01 | 3ヶ月 | IRLモデルの学習データ |
| 学習期間 | 2019-10-01 | 2020-01-01 | 3ヶ月 | 軌跡構築・特徴量抽出 |
| 待機期間 | 2020-01-01 | 2020-04-01 | 3ヶ月 | （判定開始まで待つ） |
| 判定期間 | 2020-04-01 | 以降 | - | 2020-04-01以降の活動で判定 |

**意味**: 「3ヶ月後も残っているか？」を予測

### 例2: 6ヶ月学習 × 9ヶ月予測

| 期間の種類 | 開始日 | 終了日 | 期間長 | 用途 |
|-----------|--------|--------|--------|------|
| IRL学習期間 | 2019-07-01 | 2020-01-01 | 6ヶ月 | IRLモデルの学習データ |
| 学習期間 | 2019-07-01 | 2020-01-01 | 6ヶ月 | 軌跡構築・特徴量抽出 |
| 待機期間 | 2020-01-01 | 2020-10-01 | 9ヶ月 | （判定開始まで待つ） |
| 判定期間 | 2020-10-01 | 以降 | - | 2020-10-01以降の活動で判定 |

**意味**: 「9ヶ月後も残っているか？」を予測

### 例3: 12ヶ月学習 × 12ヶ月予測

| 期間の種類 | 開始日 | 終了日 | 期間長 | 用途 |
|-----------|--------|--------|--------|------|
| IRL学習期間 | 2019-01-01 | 2020-01-01 | 12ヶ月 | IRLモデルの学習データ |
| 学習期間 | 2019-01-01 | 2020-01-01 | 12ヶ月 | 軌跡構築・特徴量抽出 |
| 待機期間 | 2020-01-01 | 2021-01-01 | 12ヶ月 | （判定開始まで待つ） |
| 判定期間 | 2021-01-01 | 以降 | - | 2021-01-01以降の活動で判定 |

**意味**: 「12ヶ月後も残っているか？」を予測

**重要ポイント**:
- **IRL学習期間 = 学習期間**（同じ期間を指す）
- **予測期間 = 待機期間**（判定開始までの時間）
- **判定は待機期間後**（n ヶ月後以降に活動があるか）

## リサーチクエスチョン

### 1. 最適な期間設定

- **質問**: どの学習期間と予測期間の組み合わせが最高性能を示すか？
- **方法**: ヒートマップでAUC-ROCが最も高い箇所を特定
- **予想**: 長い学習期間（9-12ヶ月）がより良い性能を示す

### 2. 予測可能な時間範囲

- **質問**: どの程度先まで信頼性の高い予測が可能か？
- **方法**: 予測期間別のAUC-ROCを比較
- **予想**: 予測期間が長いほど性能が低下

### 3. データ効率性

- **質問**: 3ヶ月の履歴で十分な予測精度が得られるか？
- **方法**: 3ヶ月学習 vs 12ヶ月学習を比較
- **予想**: 6-9ヶ月以降は収穫逓減

### 4. プロジェクト固有 vs 汎用モデル

- **質問**: プロジェクト固有モデルは汎用モデルより優れるか？
- **方法**: 単一プロジェクト vs 複数プロジェクトの結果を比較
- **予想**: 大規模プロジェクト（cinder, nova）では固有モデルが優位

### 5. クロスプロジェクト汎化

- **質問**: 全プロジェクトで学習したモデルは個別プロジェクトにも有効か？
- **方法**: 複数プロジェクトモデル vs 各プロジェクト固有モデル
- **洞察**: 複数プロジェクトモデルが良好なら普遍的に展開可能

## トラブルシューティング

### 想定される問題

1. **設定に対するデータ不足**
   - **症状**: "Skipping: No trajectories"
   - **原因**: 学習期間内のレビュー数が不足
   - **解決策**: より早いスナップショット日を使用、または期間を短縮

2. **低い継続率**
   - **症状**: 不均衡データセットの警告
   - **影響**: AUC-PRは高いがF1が低い
   - **対策**: AUC-PR指標に注目

3. **メモリ不足**
   - **症状**: OOMエラー
   - **解決策**: seq_lenまたはバッチサイズを削減

4. **学習の不安定性**
   - **症状**: NaNまたは0.5のAUC-ROC
   - **原因**: 学習率が高すぎる、または勾配爆発
   - **解決策**: LayerNormとDropoutが有効か確認

## 評価後の次のステップ

1. **結果分析**
   - 最良設定の特定
   - プロジェクト固有パターンの理解
   - EVALUATION_REPORT.mdへの洞察の文書化

2. **モデル選定**
   - 本番用モデルの選択
   - 選定基準の文書化

3. **さらなる研究**
   - 追加プロジェクトでのテスト
   - 特徴量エンジニアリングの実験
   - アンサンブル手法の試行

4. **デプロイ計画**
   - 推論パイプラインの構築
   - モニタリング設定
   - 再学習スケジュールの定義

## 参考資料

- **EnhancedRetentionIRLSystem**: `src/gerrit_retention/rl_prediction/enhanced_retention_irl_system.py`
- **データ分析**: `importants/true_irl_comprehensive/data_analysis/ANALYSIS_REPORT.txt`
- **プロジェクトREADME**: `README_TEMPORAL_IRL.md`
- **英語版計画書**: `importants/true_irl_comprehensive/EVALUATION_PLAN.md`

---

**ドキュメント状態**: 実行準備完了
**次のアクション**: 評価スクリプトの実行
**予想完了時間**: 開始から3-4時間後
