# 拡張特徴量IRLの使用

**更新日**: 2025-10-19

## 変更内容

基本的な10次元状態 + 5次元行動から、**拡張版の32次元状態 + 9次元行動**に変更しました。

## 特徴量の比較

| 項目 | 基本版 | 拡張版 |
|------|--------|--------|
| 状態特徴量 | 10次元 | **32次元** |
| 行動特徴量 | 5次元 | **9次元** |
| 合計次元数 | 15次元 | **41次元** |
| 特徴量抽出器 | シンプルな計算 | EnhancedFeatureExtractor |

## 拡張状態特徴量（32次元）の内訳

### 基本特徴量（10次元）
1. 経験日数
2. 変更総数
3. レビュー総数
4. プロジェクト数
5. 最近の活動頻度
6. 平均活動間隔
7. 活動トレンド
8. コラボレーションスコア
9. コード品質スコア
10. 最終活動からの経過時間

### A1: 活動頻度の多期間比較（5次元）
11. 7日間の活動頻度
12. 30日間の活動頻度
13. 90日間の活動頻度
14. 活動加速度（短期 vs 中期）
15. 一貫性スコア（活動の規則性）

### B1: レビュー負荷指標（6次元）
16. 7日間のレビュー負荷（1日あたり）
17. 30日間のレビュー負荷
18. 180日間のレビュー負荷
19. レビュー負荷トレンド
20. 過負荷フラグ（1日5件以上）
21. 高負荷フラグ（1日2件以上）

### C1: 相互作用の深さ（4次元）
22. 180日間の相互作用回数
23. 相互作用強度（月あたりの相互作用数）
24. プロジェクト固有の相互作用数
25. 割り当て履歴（180日）

### D1: 専門性の一致度（2次元）
26. パス類似度スコア（Jaccard係数平均）
27. パス重複スコア（Overlap係数平均）

### その他有用指標（5次元）
28. 平均レスポンス時間（日）
29. レスポンス率（180日）
30. 在籍日数
31. 平均変更サイズ（追加+削除行数）
32. 平均変更ファイル数

## 拡張行動特徴量（9次元）の内訳

### 基本特徴量（5次元）
1. 行動タイプ（commit=1.0, review=0.8, etc.）
2. 強度（変更の大きさ）
3. 品質スコア
4. コラボレーション度
5. タイムスタンプからの経過日数

### 拡張特徴量（4次元）
6. 変更サイズ（insertions + deletions）
7. ファイル数（変更されたファイルの数）
8. 複雑度（変更サイズ / ファイル数）
9. レスポンス遅延（日数）

## 実装上の変更点

### 1. 特徴量抽出器の追加

```python
from gerrit_retention.rl_prediction.enhanced_feature_extractor import (
    EnhancedFeatureExtractor,
)

# 初期化
feature_extractor = EnhancedFeatureExtractor()
```

### 2. 状態特徴量抽出の変更

**Before (10次元)**:
```python
def extract_state_features(
    reviewer_reviews: pd.DataFrame,
    current_row: pd.Series,
    all_reviews: pd.DataFrame,
) -> np.ndarray:
    features = np.zeros(10, dtype=np.float32)
    # 簡易計算...
    return features
```

**After (32次元)**:
```python
def extract_state_features(
    reviewer_reviews: pd.DataFrame,
    current_row: pd.Series,
    all_reviews: pd.DataFrame,
    feature_extractor: EnhancedFeatureExtractor,
) -> np.ndarray:
    # 開発者情報を構築
    developer = {...}
    activity_history = [...]

    # 拡張特徴量抽出
    enhanced_state = feature_extractor.extract_enhanced_state(
        developer=developer,
        activity_history=activity_history,
        context_date=current_row["timestamp"]
    )

    # 32次元配列に変換
    return feature_extractor.state_to_array(enhanced_state)
```

### 3. 行動特徴量抽出の変更

**Before (5次元)**:
```python
def extract_action_features(row: pd.Series) -> np.ndarray:
    features = np.zeros(5, dtype=np.float32)
    # 簡易計算...
    return features
```

**After (9次元)**:
```python
def extract_action_features(
    row: pd.Series,
    feature_extractor: EnhancedFeatureExtractor,
) -> np.ndarray:
    activity = {
        'type': 'review',
        'timestamp': row['timestamp'].isoformat(),
        'change_insertions': row.get('lines_added', 0),
        'change_deletions': row.get('lines_deleted', 0),
        'change_files_count': row.get('files_changed', 1),
        'response_latency_days': 0.0,
    }

    enhanced_action = feature_extractor.extract_enhanced_action(
        activity=activity,
        context_date=row['timestamp']
    )

    # 9次元配列に変換
    return feature_extractor.action_to_array(enhanced_action)
```

### 4. モデル設定の変更

**Before**:
```python
config = {
    "state_dim": 10,
    "action_dim": 5,
    ...
}
```

**After**:
```python
config = {
    "state_dim": 32,  # Enhanced state features
    "action_dim": 9,  # Enhanced action features
    ...
}
```

## データ制約とシミュレーション

CSVファイル（`review_requests_openstack_multi_5y_detail.csv`）には拡張特徴量の計算に必要な全ての情報が含まれていません。

### 利用可能なデータ

- `timestamp`: タイムスタンプ
- `reviewer` / `reviewer_email`: レビュアー識別子
- `project`: プロジェクト名
- `lines_added`: 追加行数
- `lines_deleted`: 削除行数
- `files_changed`: 変更ファイル数

### シミュレーション値（デフォルト値を使用）

以下の特徴量はデータがないため、デフォルト値またはダミー値を使用:

- **B1: レビュー負荷指標** → 0（割り当てデータなし）
- **C1: 相互作用の深さ** → 0（相互作用履歴なし）
- **D1: 専門性の一致度** → 0.0（パス情報なし）
- **レスポンス時間** → 0.0（レスポンスデータなし）

### 実際に計算される特徴量

CSVから計算可能:
- **基本特徴量**: 経験日数、レビュー数、プロジェクト数、活動頻度など
- **A1: 活動頻度**: 7日/30日/90日の活動頻度、加速度、一貫性
- **変更関連**: 変更サイズ、ファイル数、複雑度

## 期待される効果

拡張特徴量により、以下の改善が期待されます:

1. **時間的パターンの捕捉**: 短期・中期・長期の活動パターンを区別
2. **活動変化の検出**: 加速度やトレンドで活動の変化を捉える
3. **一貫性の評価**: 規則的な活動か不規則かを判定
4. **変更特性の理解**: 大規模変更 vs 小規模変更、複雑度の違い

## 今後の改善可能性

完全な拡張特徴量を使用するには、以下のデータが必要:

1. **レビュー割り当て履歴**: B1特徴量の正確な計算
2. **開発者間相互作用データ**: C1特徴量の計算
3. **ファイルパス情報**: D1特徴量（専門性一致度）の計算
4. **レスポンスタイム**: 実際のレビューレスポンス時間

これらのデータが利用可能になれば、さらに精度の高い予測が可能になります。

## 実行方法

変更後も実行コマンドは同じです:

```bash
uv run python scripts/training/irl/evaluate_true_irl_comprehensive.py \
  --reviews data/review_requests_openstack_multi_5y_detail.csv \
  --snapshot-date 2020-01-01 \
  --learning-months 3 6 9 12 \
  --prediction-months 3 6 9 12 \
  --mode both \
  --epochs 30 \
  --seq-len 15 \
  --output importants/true_irl_comprehensive
```

## 参考資料

- **拡張特徴量抽出器**: `src/gerrit_retention/rl_prediction/enhanced_feature_extractor.py`
- **評価スクリプト**: `scripts/training/irl/evaluate_true_irl_comprehensive.py`
- **実装方針**: `importants/true_irl_comprehensive/実装方針.md`

---

**重要**: 拡張特徴量の多くはCSVデータの制約により部分的にしか計算できませんが、利用可能な情報から最大限の特徴量を抽出します。
