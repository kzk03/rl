# 予測定義サマリー

## 重要な変更点

### 従来の定義（誤り）
❌ 予測期間**内**に活動があるかを予測

### 新しい定義（正しい）
✅ 予測期間**後**に活動があるかを予測（n ヶ月後も残っているか）

## タイムライン図

```
         学習期間          待機期間         判定期間
    ┌──────────────┐  ┌──────────┐  ┌─────────────→
────┴──────────────┴──┴──────────┴──┴─────────────→
    ↑              ↑              ↑
    │              │              │
IRL学習開始   スナップショット  判定開始日
              (予測起点)      (n ヶ月後)
                              ここから先の活動で判定
```

## 具体例

### 3ヶ月学習 × 6ヶ月予測

```
2019-10-01      2020-01-01      2020-07-01      将来...
    |               |               |               |
    |<--- 3m ---->|<----- 6m ----->|               |
    |               |    (待機)     |   (判定)      |
    ↑               ↑               ↑
IRL学習開始     スナップショット  判定開始
```

**判定ロジック**:
```python
if レビュアーが2020-07-01以降に活動あり:
    label = 1  # 継続（6ヶ月後も残っている）
else:
    label = 0  # 離脱（6ヶ月後には活動していない）
```

**意味**: 「6ヶ月後も残っているか？」を予測

### 12ヶ月学習 × 3ヶ月予測

```
2019-01-01                  2020-01-01  2020-04-01  将来...
    |                           |           |           |
    |<--------- 12m ---------->|<-- 3m -->|           |
    |                           | (待機)   | (判定)    |
    ↑                           ↑           ↑
IRL学習開始                 スナップショット 判定開始
```

**判定ロジック**:
```python
if レビュアーが2020-04-01以降に活動あり:
    label = 1  # 継続（3ヶ月後も残っている）
else:
    label = 0  # 離脱（3ヶ月後には活動していない）
```

**意味**: 「3ヶ月後も残っているか？」を予測

## 実装上の変更

### コード（before）

```python
# 予測期間のレビュー（間違い）
prediction_df = df_filtered[
    (df_filtered["timestamp"] >= snapshot_date) &
    (df_filtered["timestamp"] < snapshot_date + timedelta(days=prediction_months * 30))
]
```

### コード（after）

```python
# 判定開始日以降のレビュー（正しい）
prediction_start = snapshot_date + timedelta(days=prediction_months * 30)
post_prediction_df = df_filtered[
    df_filtered["timestamp"] >= prediction_start
]
```

## 実用的な意味

| 設定 | 予測内容 |
|------|---------|
| 3ヶ月予測 | 「3ヶ月後も残っているか？」 |
| 6ヶ月予測 | 「6ヶ月後も残っているか？」 |
| 9ヶ月予測 | 「9ヶ月後も残っているか？」 |
| 12ヶ月予測 | 「12ヶ月後も残っているか？」 |

この定義により、より実用的で意味のある予測タスクになります。

## 期間の用語整理

| 用語 | 英語 | 意味 | 計算 |
|------|------|------|------|
| IRL学習期間 | IRL Training Period | IRLモデルを学習するデータ期間 | `[snapshot - learning_months, snapshot]` |
| 学習期間 | Learning Period | 軌跡構築に使う観測期間 | `[snapshot - learning_months, snapshot]` |
| 予測期間/待機期間 | Prediction/Waiting Period | 判定開始までの待ち時間 | `prediction_months` |
| 判定期間 | Check Period | 継続判定を行う期間 | `[snapshot + prediction_months, ∞)` |

**重要**: IRL学習期間と学習期間は同じ期間を指す（同じ開始日・終了日）

---

**作成日**: 2025-10-19
**関連ファイル**:
- `scripts/training/irl/evaluate_true_irl_comprehensive.py`
- `importants/true_irl_comprehensive/実装方針.md`
- `importants/true_irl_comprehensive/EVALUATION_PLAN.md`
